@model PharmaCare.Domain.Models.SaleManagement.Quotation
@{
    ViewData["Title"] = "Quotation Details";
}

<div class="container-fluid p-0">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas fa-file-alt me-2"></i>Quotation: @Model.QuotationNumber</h4>
        <a href="@Url.Action("QuotationIndex")" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to List
        </a>
    </div>

    <div class="row">
        <!-- Quote Info -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Quotation Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <td class="fw-bold">Quote Number:</td>
                            <td>@Model.QuotationNumber</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Date:</td>
                            <td>@Model.QuotationDate.ToString("dd-MMM-yyyy")</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Valid Until:</td>
                            <td class="@(Model.ValidUntil < DateTime.Now ? "text-danger fw-bold" : "")">
                                @Model.ValidUntil.ToString("dd-MMM-yyyy")
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Status:</td>
                            <td>
                                @{
                                    var badgeClass = Model.Status switch
                                    {
                                        "Draft" => "bg-info",
                                        "Converted" => "bg-success",
                                        "Expired" => "bg-warning",
                                        "Cancelled" => "bg-danger",
                                        _ => "bg-secondary"
                                    };
                                }
                                <span class="badge @badgeClass fs-6">@Model.Status</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Customer:</td>
                            <td>@(Model.Party?.PartyName ?? Model.CustomerName ?? "Walk-in")</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Phone:</td>
                            <td>@(Model.CustomerPhone ?? "N/A")</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Store:</td>
                            <td>@Model.Store?.Name</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Actions -->
            @if (Model.Status == "Draft")
            {
                <div class="card mb-3">
                    <div class="card-body">
                        <form asp-action="ConvertToSale" asp-route-id="@Model.QuotationID" method="post"
                            onsubmit="return confirm('Convert this quotation to a sale?');">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-success btn-lg w-100 mb-2">
                                <i class="fas fa-shopping-cart me-1"></i> Convert to Sale
                            </button>
                        </form>
                        <form asp-action="CancelQuotation" asp-route-id="@Model.QuotationID" method="post"
                            onsubmit="return confirm('Cancel this quotation?');">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="fas fa-times-circle me-1"></i> Cancel Quotation
                            </button>
                        </form>
                    </div>
                </div>
            }
            @if (Model.Status == "Converted" && Model.ConvertedStockMain_ID.HasValue)
            {
                <div class="card">
                    <div class="card-body">
                        <a href="@Url.Action("Receipt", "Pos", new { id = Utility.EncryptURL(Model.ConvertedStockMain_ID.Value.ToString()) })"
                            class="btn btn-primary w-100">
                            <i class="fas fa-receipt me-1"></i> View Related Sale
                        </a>
                    </div>
                </div>
            }
        </div>

        <!-- Items -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Quoted Items</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-bordered table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Product</th>
                                <th>Batch</th>
                                <th class="text-center">Qty</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Discount</th>
                                <th class="text-end">Net Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var line in Model.QuotationLines)
                            {
                                <tr>
                                    <td>@line.Product?.ProductName</td>
                                    <td>@line.ProductBatch?.BatchNumber</td>
                                    <td class="text-center">@line.Quantity</td>
                                    <td class="text-end">@line.UnitPrice.ToString("N2")</td>
                                    <td class="text-end text-danger">@line.DiscountAmount.ToString("N2")</td>
                                    <td class="text-end fw-bold">@line.NetAmount.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <td colspan="5" class="text-end">Subtotal:</td>
                                <td class="text-end">@Model.SubTotal.ToString("N2")</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-end text-danger">Discount:</td>
                                <td class="text-end text-danger">-@Model.DiscountAmount.ToString("N2")</td>
                            </tr>
                            <tr class="table-primary">
                                <td colspan="5" class="text-end fw-bold fs-5">Grand Total:</td>
                                <td class="text-end fw-bold text-primary fs-5">@Model.GrandTotal.ToString("N2")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Model.Notes))
            {
                <div class="card mt-3">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Notes</h5>
                    </div>
                    <div class="card-body">
                        @Model.Notes
                    </div>
                </div>
            }
        </div>
    </div>
</div>
