@model PharmaCare.Domain.Models.SaleManagement.Quotation
@{
    ViewData["Title"] = "Create Quotation";
}

<div class="container-fluid p-0">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas fa-file-alt me-2"></i>Create Quotation</h4>
        <a href="@Url.Action("QuotationIndex")" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to List
        </a>
    </div>

    <form asp-action="AddQuotation" method="post" id="quotationForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Store_ID" />

        <div class="row">
            <!-- Quotation Info -->
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Quotation Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Quotation Date</label>
                            <input type="date" asp-for="QuotationDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valid Until</label>
                            <input type="date" asp-for="ValidUntil" class="form-control" value="@DateTime.Now.AddDays(30).ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Customer</label>
                            @Html.DropDownList("Party_ID", ViewBag.Customers as SelectList, "Walk-in Customer", new { @class = "form-select" })
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Customer Name</label>
                            <input type="text" asp-for="CustomerName" class="form-control" placeholder="For walk-in customers" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Customer Phone</label>
                            <input type="text" asp-for="CustomerPhone" class="form-control" placeholder="Phone number" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea asp-for="Notes" class="form-control" rows="2" placeholder="Optional notes..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Search & Items -->
            <div class="col-md-8">
                <!-- Product Search -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-search me-2"></i>Add Products</h5>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" id="productSearch" class="form-control form-control-lg" 
                                placeholder="Search products by name or barcode..." autocomplete="off">
                            <button class="btn btn-primary" type="button" onclick="searchProducts()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="searchResults" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Quotation Lines -->
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Quotation Items</h5>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-bordered table-striped mb-0" id="itemsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Product</th>
                                    <th>Batch</th>
                                    <th class="text-center" style="width: 100px;">Qty</th>
                                    <th class="text-end" style="width: 120px;">Unit Price</th>
                                    <th class="text-end" style="width: 100px;">Discount %</th>
                                    <th class="text-end" style="width: 120px;">Net Amount</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="itemsBody">
                                <tr id="emptyRow">
                                    <td colspan="7" class="text-center text-muted py-4">
                                        No items added. Search and add products above.
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <td colspan="5" class="text-end fw-bold">Subtotal:</td>
                                    <td class="text-end fw-bold" id="subtotalDisplay">0.00</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="5" class="text-end">
                                        <span class="fw-bold">Invoice Discount:</span>
                                        <input type="number" id="invoiceDiscount" class="form-control form-control-sm d-inline-block" 
                                            style="width: 80px;" value="0" min="0" step="0.01" onchange="recalculateTotals()">
                                        %
                                    </td>
                                    <td class="text-end text-danger" id="discountDisplay">0.00</td>
                                    <td></td>
                                </tr>
                                <tr class="table-primary">
                                    <td colspan="5" class="text-end fw-bold fs-5">Grand Total:</td>
                                    <td class="text-end fw-bold text-primary fs-5" id="grandTotalDisplay">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Hidden fields for form submission -->
                <div id="hiddenFields"></div>
            </div>
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-success btn-lg" onclick="return validateAndSubmit()">
                <i class="fas fa-save me-1"></i> Save Quotation
            </button>
        </div>
    </form>
</div>

@section Scripts {
        <script>
            let quotationItems = [];
            let itemIndex = 0;

            function searchProducts() {
                const query = $('#productSearch').val();
                if (query.length < 2) return;

                $.get('/Quotation/SearchProducts', { query: query }, function(products) {
                    displaySearchResults(products);
                });
            }

            $('#productSearch').on('keyup', function(e) {
                if (e.key === 'Enter') searchProducts();
            });

            function displaySearchResults(products) {
                const container = $('#searchResults');
                if (!products || products.length === 0) {
                    container.html('<div class="text-muted text-center py-2">No products found</div>');
                    return;
                }

                let html = '<table class="table table-sm table-hover mb-0"><tbody>';
                products.forEach(p => {
                    if (p.availableBatches && p.availableBatches.length > 0) {
                        p.availableBatches.forEach(b => {
                            html += `
                                <tr>
                                    <td>${p.brandName}</td>
                                    <td>${b.batchNumber}</td>
                                    <td>Stock: ${b.availableQuantity}</td>
                                    <td>PKR ${b.price.toFixed(2)}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-primary" 
                                            onclick="addItem(${p.productID}, ${b.productBatchID}, '${escapeQuotes(p.brandName)}', '${b.batchNumber}', ${b.price})">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                });
                html += '</tbody></table>';
                container.html(html);
            }

            function escapeQuotes(str) {
                return str ? str.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
            }

            function addItem(productId, batchId, productName, batchNumber, price) {
                // Check if already exists
                const existing = quotationItems.find(i => i.batchId === batchId);
                if (existing) {
                    existing.quantity++;
                    renderItems();
                    return;
                }

                quotationItems.push({
                    index: itemIndex++,
                    productId: productId,
                    batchId: batchId,
                    productName: productName,
                    batchNumber: batchNumber,
                    price: price,
                    quantity: 1,
                    discountPercent: 0
                });

                renderItems();
                $('#searchResults').html('');
                $('#productSearch').val('').focus();
            }

            function removeItem(index) {
                quotationItems = quotationItems.filter(i => i.index !== index);
                renderItems();
            }

            function updateQuantity(index, qty) {
                const item = quotationItems.find(i => i.index === index);
                if (item) {
                    item.quantity = parseFloat(qty) || 0;
                    recalculateTotals();
                }
            }

            function updateDiscount(index, discount) {
                const item = quotationItems.find(i => i.index === index);
                if (item) {
                    item.discountPercent = parseFloat(discount) || 0;
                    recalculateTotals();
                }
            }

            function renderItems() {
                const tbody = $('#itemsBody');

                if (quotationItems.length === 0) {
                    tbody.html(`
                        <tr id="emptyRow">
                            <td colspan="7" class="text-center text-muted py-4">
                                No items added. Search and add products above.
                            </td>
                        </tr>
                    `);
                    recalculateTotals();
                    return;
                }

                let html = '';
                quotationItems.forEach(item => {
                    const lineTotal = item.quantity * item.price;
                    const discountAmt = lineTotal * (item.discountPercent / 100);
                    const netAmount = lineTotal - discountAmt;

                    html += `
                        <tr>
                            <td>${item.productName}</td>
                            <td>${item.batchNumber}</td>
                            <td>
                                <input type="number" class="form-control form-control-sm text-center" 
                                    value="${item.quantity}" min="1" step="1"
                                    onchange="updateQuantity(${item.index}, this.value)">
                            </td>
                            <td class="text-end">${item.price.toFixed(2)}</td>
                            <td>
                                <input type="number" class="form-control form-control-sm text-center" 
                                    value="${item.discountPercent}" min="0" max="100" step="0.01"
                                    onchange="updateDiscount(${item.index}, this.value)">
                            </td>
                            <td class="text-end fw-bold">${netAmount.toFixed(2)}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(${item.index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.html(html);
                recalculateTotals();
            }

            function recalculateTotals() {
                let subtotal = 0;
                quotationItems.forEach(item => {
                    const lineTotal = item.quantity * item.price;
                    const discountAmt = lineTotal * (item.discountPercent / 100);
                    subtotal += lineTotal - discountAmt;
                });

                const invoiceDiscountPercent = parseFloat($('#invoiceDiscount').val()) || 0;
                const discountAmount = subtotal * (invoiceDiscountPercent / 100);
                const grandTotal = subtotal - discountAmount;

                $('#subtotalDisplay').text(subtotal.toFixed(2));
                $('#discountDisplay').text(discountAmount.toFixed(2));
                $('#grandTotalDisplay').text(grandTotal.toFixed(2));
            }

            function validateAndSubmit() {
                if (quotationItems.length === 0) {
                    alert('Please add at least one item to the quotation.');
                    return false;
                }

                // Build hidden fields for quotation lines
                const hiddenContainer = $('#hiddenFields');
                hiddenContainer.empty();

                const invoiceDiscountPercent = parseFloat($('#invoiceDiscount').val()) || 0;
                hiddenContainer.append(`<input type="hidden" name="DiscountPercent" value="${invoiceDiscountPercent}">`);

                quotationItems.forEach((item, idx) => {
                    const lineTotal = item.quantity * item.price;
                    const discountAmt = lineTotal * (item.discountPercent / 100);
                    const netAmount = lineTotal - discountAmt;

                    hiddenContainer.append(`
                        <input type="hidden" name="QuotationLines[${idx}].Product_ID" value="${item.productId}">
                        <input type="hidden" name="QuotationLines[${idx}].ProductBatch_ID" value="${item.batchId}">
                        <input type="hidden" name="QuotationLines[${idx}].Quantity" value="${item.quantity}">
                        <input type="hidden" name="QuotationLines[${idx}].UnitPrice" value="${item.price}">
                        <input type="hidden" name="QuotationLines[${idx}].DiscountPercent" value="${item.discountPercent}">
                        <input type="hidden" name="QuotationLines[${idx}].DiscountAmount" value="${discountAmt}">
                        <input type="hidden" name="QuotationLines[${idx}].NetAmount" value="${netAmount}">
                    `);
                });

                return true;
            }
        </script>
}
