@model PharmaCare.Domain.Models.AccountManagement.AccountMapping
@inject PharmaCare.Infrastructure.Interfaces.IComboBoxRepository _comboBox
@{
    ViewData["Title"] = "Edit Account Mapping";
}

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <h4 class="card-header">Edit Account Mapping</h4>
            <div class="card-body mt-2">
                <form asp-action="EditMapping" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="AccountMappingID" />
                    <input type="hidden" asp-for="CreatedBy" />
                    <input type="hidden" asp-for="CreatedDate" />
                    <input type="hidden" asp-for="IsActive" />

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label asp-for="PartyType" class="form-label"></label>
                            <select asp-for="PartyType" class="form-select" id="partyType">
                                <option value="">-- Select Party Type --</option>
                                <option value="Customer">Customer</option>
                                <option value="Supplier">Supplier</option>
                                <option value="Both">Both</option>
                                <option value="Other">Other</option>
                            </select>
                            <span asp-validation-for="PartyType" class="text-danger"></span>
                        </div>
                    </div>

                    <hr />
                    <h6 class="text-muted mb-3">Account Assignment</h6>

                    <!-- Head & Subhead Section - shown for Customer/Supplier/Both -->
                    <div class="row mb-3" id="headSubheadSection">
                        <div class="col-md-6">
                            <label asp-for="Head_ID" class="form-label"></label>
                            <select asp-for="Head_ID" class="form-select" id="headId"
                                asp-items="@_comboBox.GetHeads(Model.Head_ID)">
                                <option value="">-- Select Head --</option>
                            </select>
                            <span asp-validation-for="Head_ID" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Subhead_ID" class="form-label"></label>
                            <select asp-for="Subhead_ID" class="form-select" id="subheadId">
                                <option value="">-- Select Subhead --</option>
                            </select>
                            <span asp-validation-for="Subhead_ID" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Chart of Account Section - shown for Other types -->
                    <div class="row mb-3" id="chartOfAccountSection" style="display: none;">
                        <div class="col-md-12">
                            <label asp-for="Account_ID" class="form-label">Chart of Account</label>
                            <select asp-for="Account_ID" class="form-select" id="accountId"
                                asp-items="@_comboBox.GetAllAccounts(Model.Account_ID)">
                                <option value="">-- Select Account --</option>
                            </select>
                            <span asp-validation-for="Account_ID" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="mt-3 d-flex justify-content-end gap-2">
                        <a asp-action="AccountMappingIndex" class="btn btn-secondary"><i class="bx bx-arrow-back me-1"></i> Back to list</a>
                        <button type="submit" class="btn btn-success">Update Mapping</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var initialHeadId = '@Model.Head_ID';
            var initialSubheadId = '@Model.Subhead_ID';

            // Toggle visibility based on PartyType
            function toggleSections() {
                var partyType = $('#partyType').val();
                var isPartyType = (partyType === 'Customer' || partyType === 'Supplier' || partyType === 'Both');

                if (isPartyType) {
                    $('#headSubheadSection').show();
                    $('#chartOfAccountSection').hide();
                } else if (partyType === 'Other') {
                    $('#headSubheadSection').hide();
                    $('#chartOfAccountSection').show();
                } else {
                    $('#headSubheadSection').hide();
                    $('#chartOfAccountSection').hide();
                }
            }

            // Load subheads for a given head
            function loadSubheads(headId, selectedSubheadId) {
                if (headId) {
                    var subheadDropdown = $('#subheadId');
                    subheadDropdown.empty().append('<option value="">-- Loading... --</option>');

                    $.getJSON('@Url.Action("GetSubheadsByHead", "AccountMapping")', { headId: headId }, function (data) {
                        subheadDropdown.empty().append('<option value="">-- Select Subhead --</option>');
                        $.each(data, function (i, item) {
                            var option = $('<option></option>').val(item.id).text(item.name);
                            if (item.id == selectedSubheadId) {
                                option.attr('selected', 'selected');
                            }
                            subheadDropdown.append(option);
                        });
                    });
                }
            }

            // PartyType change event
            $('#partyType').change(function () {
                toggleSections();
            });

            // Head -> Subhead dropdown cascade
            $('#headId').change(function () {
                var headId = $(this).val();
                loadSubheads(headId, null);
            });

            // Initialize on page load
            toggleSections();

            // Load initial subheads if head is selected
            if (initialHeadId && initialHeadId !== '') {
                loadSubheads(initialHeadId, initialSubheadId);
            }
        });
    </script>
}
