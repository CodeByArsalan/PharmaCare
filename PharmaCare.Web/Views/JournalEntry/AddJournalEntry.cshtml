@model PharmaCare.Application.DTOs.Accounting.JournalEntryDto
@inject PharmaCare.Infrastructure.Interfaces.IComboBoxRepository _comboBox
@{
    ViewData["Title"] = "New Journal Entry";
}

<div class="row page-titles mb-2 mt-2">
    <div class="col-md-5 align-self-center">
        <h3 class="text-primary fw-bold text-uppercase mb-0">New Journal Entry</h3>
    </div>
    <div class="col-md-7 align-self-center text-end">
        <a asp-action="JournalEntryIndex" class="btn btn-secondary">
            <i class="bx bx-arrow-back me-1"></i> Back to List
        </a>
    </div>
</div>

<div class="container-fluid p-0">
    <form asp-action="AddJournalEntry" method="post" id="entryForm">
        <div class="row">
            <!-- Entry Header -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-3 mb-4">
                    <div class="card-header bg-primary text-white p-3 rounded-top-3">
                        <h5 class="card-title mb-0 fw-bold">Manual Entry Header</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label asp-for="EntryDate"
                                class="form-label fw-bold text-secondary small text-uppercase">Transaction Date <span
                                    class="text-danger">*</span></label>
                            <input asp-for="EntryDate" class="form-control shadow-sm rounded-3" type="date" required />
                        </div>
                        <div class="mb-3">
                            <label asp-for="Reference"
                                class="form-label fw-bold text-secondary small text-uppercase">Reference / Doc #</label>
                            <input asp-for="Reference" class="form-control shadow-sm rounded-3"
                                placeholder="e.g., ADJ-001" />
                        </div>
                        <div class="mb-3">
                            <label asp-for="Description"
                                class="form-label fw-bold text-secondary small text-uppercase">Overall Narrative <span
                                    class="text-danger">*</span></label>
                            <textarea asp-for="Description" class="form-control shadow-sm rounded-3" rows="4"
                                placeholder="Reason for this adjustment..." required></textarea>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-3 alert alert-info p-3 mb-4">
                    <div class="d-flex">
                        <div class="me-3"><i class="fas fa-info-circle h4 mb-0 opacity-50"></i></div>
                        <div>
                            <div class="fw-bold mb-1">Accounting Check</div>
                            <div class="small">Every manual entry MUST balance. Total Debits must exactly equal Total
                                Credits before you can save.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entry Lines -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-3 mb-4">
                    <div class="card-header bg-white p-3 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 fw-bold">Transaction Lines</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3"
                            onclick="addLine()">
                            <i class="fas fa-plus me-1"></i> Add Line
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table align-middle mb-0" id="linesTable">
                                <thead class="bg-light-soft text-secondary border-bottom">
                                    <tr>
                                        <th style="width: 35%;" class="ps-4">Account</th>
                                        <th style="width: 35%;">Line Description</th>
                                        <th style="width: 12%; text-end">Debit</th>
                                        <th style="width: 12%; text-end">Credit</th>
                                        <th style="width: 6%; text-center"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="line-row">
                                        <td class="ps-4">
                                            <select name="Lines[0].Account_ID"
                                                class="form-select border-0 bg-transparent shadow-none select2-account"
                                                required>
                                                <option value="">-- Select Account --</option>
                                                @foreach (var acc in _comboBox.GetAllAccounts())
                                                {
                                                    <option value="@acc.Value">@acc.Text</option>
                                                }
                                            </select>
                                        </td>
                                        <td>
                                            <input name="Lines[0].Description"
                                                class="form-control border-0 bg-transparent shadow-none"
                                                placeholder="Description..." />
                                        </td>
                                        <td>
                                            <input name="Lines[0].DebitAmount" type="number" step="0.01" value="0.00"
                                                class="form-control border-0 bg-transparent shadow-none text-end debit-input"
                                                onchange="calculateTotals()" />
                                        </td>
                                        <td>
                                            <input name="Lines[0].CreditAmount" type="number" step="0.01" value="0.00"
                                                class="form-control border-0 bg-transparent shadow-none text-end credit-input"
                                                onchange="calculateTotals()" />
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-link text-danger p-0"
                                                onclick="removeLine(this)"><i class="fas fa-times"></i></button>
                                        </td>
                                    </tr>
                                    <tr class="line-row">
                                        <td class="ps-4">
                                            <select name="Lines[1].Account_ID"
                                                class="form-select border-0 bg-transparent shadow-none select2-account"
                                                required>
                                                <option value="">-- Select Account --</option>
                                                @foreach (var acc in _comboBox.GetAllAccounts())
                                                {
                                                    <option value="@acc.Value">@acc.Text</option>
                                                }
                                            </select>
                                        </td>
                                        <td>
                                            <input name="Lines[1].Description"
                                                class="form-control border-0 bg-transparent shadow-none"
                                                placeholder="Description..." />
                                        </td>
                                        <td>
                                            <input name="Lines[1].DebitAmount" type="number" step="0.01" value="0.00"
                                                class="form-control border-0 bg-transparent shadow-none text-end debit-input"
                                                onchange="calculateTotals()" />
                                        </td>
                                        <td>
                                            <input name="Lines[1].CreditAmount" type="number" step="0.01" value="0.00"
                                                class="form-control border-0 bg-transparent shadow-none text-end credit-input"
                                                onchange="calculateTotals()" />
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-link text-danger p-0"
                                                onclick="removeLine(this)"><i class="fas fa-times"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot class="bg-light border-top border-2">
                                    <tr class="fw-bold">
                                        <td colspan="2" class="text-end py-3">Totals</td>
                                        <td class="text-end text-primary py-3" id="totalDebit">0.00</td>
                                        <td class="text-end text-success py-3 pe-4" id="totalCredit">0.00</td>
                                        <td></td>
                                    </tr>
                                    <tr id="balanceAlertRow" style="display:none;">
                                        <td colspan="5" class="py-1 text-center bg-danger text-white small">
                                            Difference: <span id="differenceAmount">0.00</span> - Entry must balance!
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="text-end mb-5">
                    <button type="button" class="btn btn-outline-info rounded-pill px-4 me-2"
                        onclick="validateBalance()">
                        <i class="fas fa-tasks me-1"></i> Verify Balance
                    </button>
                    <button type="submit" class="btn btn-primary shadow rounded-pill px-5 py-2" id="saveBtn" disabled>
                        <i class="fas fa-save me-1"></i> Create Voucher
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        let lineIndex = 2;

        function addLine() {
            var accountsHtml = $('#linesTable tbody tr:first select').html();
            var newRow = `
                    <tr class="line-row">
                        <td class="ps-4">
                            <select name="Lines[${lineIndex}].AccountID" class="form-select border-0 bg-transparent shadow-none select2-account" required>
                                ${accountsHtml}
                            </select>
                        </td>
                        <td>
                            <input name="Lines[${lineIndex}].Description" class="form-control border-0 bg-transparent shadow-none" placeholder="Description..." />
                        </td>
                        <td>
                            <input name="Lines[${lineIndex}].DebitAmount" type="number" step="0.01" value="0.00" class="form-control border-0 bg-transparent shadow-none text-end debit-input" onchange="calculateTotals()" />
                        </td>
                        <td>
                            <input name="Lines[${lineIndex}].CreditAmount" type="number" step="0.01" value="0.00" class="form-control border-0 bg-transparent shadow-none text-end credit-input" onchange="calculateTotals()" />
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-link text-danger p-0" onclick="removeLine(this)"><i class="fas fa-times"></i></button>
                        </td>
                    </tr>
                `;
            $('#linesTable tbody').append(newRow);
            lineIndex++;
            $('.select2-account').last().val(""); // Reset selection
        }

        function removeLine(btn) {
            if ($('.line-row').length > 2) {
                $(btn).closest('tr').remove();
                calculateTotals();
            } else {
                Swal.fire('Wait', 'Journal entry must have at least 2 lines.', 'info');
            }
        }

        function calculateTotals() {
            var totalDebit = 0;
            var totalCredit = 0;

            $('.debit-input').each(function () {
                var val = parseFloat($(this).val()) || 0;
                totalDebit += val;
            });

            $('.credit-input').each(function () {
                var val = parseFloat($(this).val()) || 0;
                totalCredit += val;
            });

            $('#totalDebit').text(totalDebit.toFixed(2));
            $('#totalCredit').text(totalCredit.toFixed(2));

            var diff = Math.abs(totalDebit - totalCredit);
            if (diff < 0.001 && totalDebit > 0) {
                $('#balanceAlertRow').hide();
                $('#saveBtn').prop('disabled', false).removeClass('btn-secondary').addClass('btn-primary');
            } else {
                $('#balanceAlertRow').show();
                if (totalDebit > 0 || totalCredit > 0) {
                    $('#differenceAmount').text(diff.toFixed(2));
                }
                $('#saveBtn').prop('disabled', true).addClass('btn-secondary').removeClass('btn-primary');
            }
        }

        function validateBalance() {
            calculateTotals();
            var totalDebit = parseFloat($('#totalDebit').text());
            var totalCredit = parseFloat($('#totalCredit').text());

            if (Math.abs(totalDebit - totalCredit) < 0.001 && totalDebit > 0) {
                Swal.fire('Balanced!', 'Journal entry totals match. You can now save.', 'success');
            } else {
                Swal.fire('Not Balanced', 'The total debits must equal total credits.', 'error');
            }
        }

        $(document).ready(function () {
            $('#entryForm').submit(function (e) {
                var totalDebit = parseFloat($('#totalDebit').text());
                var totalCredit = parseFloat($('#totalCredit').text());

                if (Math.abs(totalDebit - totalCredit) > 0.001 || totalDebit <= 0) {
                    e.preventDefault();
                    Swal.fire('Error', 'Please ensure the entry is balanced and contains values.', 'error');
                }
            });
        });
    </script>
}
