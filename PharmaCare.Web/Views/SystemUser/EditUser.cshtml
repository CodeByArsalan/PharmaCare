@model PharmaCare.Domain.Models.Membership.SystemUser
@inject PharmaCare.Infrastructure.Interfaces.IComboBoxRepository _comboBox

@{
    ViewData["Title"] = "Edit User";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var userid = Model.Id;
}

<div class="row">
    <div class="col-xl-12 col-lg-12 cl-md-12">
        <div class="card mb-4">
            <h4 class="card-header">Edit User</h4>
            <div class="card-body">
                <form asp-action="EditUser">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input type="hidden" asp-for="Id" value="@Model.Id" />

                    <div class="row mt-3">
                        <div class="col-md-6 mb-3">
                            <label asp-for="FullName" class="form-label"></label>
                            <input asp-for="FullName" class="form-control" />
                            <span asp-validation-for="FullName" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="UserName" class="form-label"></label>
                            <input asp-for="UserName" class="form-control" readonly />
                            <span asp-validation-for="UserName" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Email" class="form-label"></label>
                            <input asp-for="Email" class="form-control" readonly />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="UserType_ID" class="form-label">User Type</label>
                            <select asp-for="UserType_ID" class="form-select" asp-items="@_comboBox.GetUserTypes(Model.UserType_ID)">
                                <option value="">-- Select User Type --</option>
                            </select>
                            <span asp-validation-for="UserType_ID" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Store_ID" class="form-label">Store</label>
                            <select asp-for="Store_ID" class="form-select" asp-items="@_comboBox.GetStoresByLoginUserID((int)ViewBag.LoginUserID, Model.Store_ID)">
                                <option value="">-- Select Store --</option>
                            </select>
                            <span asp-validation-for="Store_ID" class="text-danger"></span>
                        </div>
                    </div>

                    @* Password change is handled separately *@

                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class='bx bx-lock-alt me-2'></i>Assign Pages & Permissions</h5>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="selectAllPages">
                                        <label class="form-check-label" for="selectAllPages">Select All</label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info d-flex align-items-center" role="alert">
                                        <i class='bx bx-info-circle me-2'></i>
                                        <div>Select the pages this user can access. Parent pages and their sub-pages can be selected.</div>
                                    </div>
                                    
                                    <div class="pages-container" style="max-height: 600px; overflow-y: auto;">
                                        @if (ViewBag.WebPages != null)
                                        {
                                            var pages = ViewBag.WebPages as List<PharmaCare.Domain.Models.Membership.WebPages>;
                                            var assignedPageIds = ViewBag.AssignedPageIds as List<int> ?? new List<int>();
                                            var parentPages = pages?.Where(p => p.Parent_ID == 0).OrderBy(p => p.PageOrder).ToList();
                                            
                                            if (parentPages != null)
                                            {
                                                <div class="accordion" id="pagesAccordion">
                                                @foreach (var parent in parentPages)
                                                {
                                                    var isParentChecked = assignedPageIds.Contains(parent.WebPageID);
                                                    <div class="accordion-item border-0 mb-2 shadow-sm rounded">
                                                        <div class="accordion-header d-flex align-items-center bg-light px-3 py-2 cursor-pointer" id="heading_@parent.WebPageID">
                                                            <div class="form-check mb-0 me-3">
                                                                <input class="form-check-input parent-checkbox" 
                                                                       type="checkbox" 
                                                                       name="SelectedPages" 
                                                                       value="@parent.WebPageID" 
                                                                       id="page_@parent.WebPageID"
                                                                       @(isParentChecked ? "checked" : "")>
                                                            </div>
                                                            <div class="flex-grow-1" data-bs-toggle="collapse" data-bs-target="#collapse_@parent.WebPageID">
                                                                <label class="form-check-label fw-bold text-dark mb-0 cursor-pointer" for="page_@parent.WebPageID">
                                                                    <i class="@parent.PageIcon me-2 text-primary"></i> <span class="h6 mb-0">@parent.PageTitle</span>
                                                                </label>
                                                            </div>
                                                            <div data-bs-toggle="collapse" data-bs-target="#collapse_@parent.WebPageID" class="ms-auto cursor-pointer">
                                                                <i class='bx bx-chevron-down fs-4'></i>
                                                            </div>
                                                        </div>
                                                        
                                                        <div id="collapse_@parent.WebPageID" class="accordion-collapse collapse" aria-labelledby="heading_@parent.WebPageID" data-bs-parent="#pagesAccordion">
                                                            <div class="accordion-body bg-white py-2">
                                                                @{
                                                                    var children = pages?.Where(p => p.Parent_ID == parent.WebPageID).OrderBy(p => p.PageOrder).ToList();
                                                                    if (children != null && children.Any())
                                                                    {
                                                                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-2">
                                                                            @foreach (var child in children)
                                                                            {
                                                                                var isChildChecked = assignedPageIds.Contains(child.WebPageID);
                                                                                <div class="col">
                                                                                    <div class="form-check p-2 rounded hover-light">
                                                                                        <input class="form-check-input child-checkbox" 
                                                                                               type="checkbox" 
                                                                                               name="SelectedPages" 
                                                                                               value="@child.WebPageID" 
                                                                                               id="page_@child.WebPageID"
                                                                                               data-parent="@parent.WebPageID"
                                                                                               @(isChildChecked ? "checked" : "")>
                                                                                        <label class="form-check-label text-secondary ms-1 cursor-pointer" for="page_@child.WebPageID">
                                                                                            <i class="@child.PageIcon me-1 small opacity-75"></i> @child.PageTitle
                                                                                        </label>
                                                                                    </div>
                                                                                </div>
                                                                            }
                                                                        </div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <div class="text-muted small ps-2 italic">No sub-pages available for this module.</div>
                                                                    }
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                </div>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3 d-flex justify-content-end gap-2">
                        <a asp-action="UserIndex" class="btn btn-secondary"><i class="bx bx-arrow-back me-1"></i>Back to list</a>
                        <button type="submit" class="btn btn-success">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        // Select All functionality  
        document.getElementById('selectAllPages')?.addEventListener('change', function(e) {
            const checkboxes = document.querySelectorAll('input[name="SelectedPages"]');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
        });

        // Auto-check parent when all children are checked
        document.querySelectorAll('.child-checkbox').forEach(child => {
            child.addEventListener('change', function() {
                const parentId = this.getAttribute('data-parent');
                const parentCheckbox = document.getElementById(`page_${parentId}`);
                const siblings = document.querySelectorAll(`.child-checkbox[data-parent="${parentId}"]`);
                const allChecked = Array.from(siblings).every(cb => cb.checked);
                
                if (allChecked && siblings.length > 0) {
                    parentCheckbox.checked = true;
                }
            });
        });

        // Auto-check/uncheck children when parent is toggled
        document.querySelectorAll('.parent-checkbox').forEach(parent => {
            parent.addEventListener('change', function() {
                const pageId = this.value;
                const children = document.querySelectorAll(`.child-checkbox[data-parent="${pageId}"]`);
                children.forEach(child => child.checked = this.checked);
            });
        });
    </script>
}
