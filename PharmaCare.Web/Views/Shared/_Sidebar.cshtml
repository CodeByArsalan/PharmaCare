@using PharmaCare.Application.Interfaces
@using PharmaCare.Application.DTOs.Security
@inject ISessionService SessionService

@{
    var sidebarMenu = SessionService.GetSidebarMenu();
    var currentController = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
}

<aside class="sidebar">
    <div class="sidebar-brand">
        <div class="sidebar-brand-icon">
            <i class="fas fa-pills"></i>
        </div>
        <span class="sidebar-brand-text">PharmaCare</span>
    </div>
    
    <nav>
        <!-- Dashboard (always shown for authenticated users) -->
        <div class="nav-section">
            <a asp-controller="Home" asp-action="Index" 
               class="nav-link @(currentController == "Home" ? "active" : "")">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
        </div>
        
        @foreach (var menuSection in sidebarMenu)
        {
            @if (menuSection.Children.Any())
            {
                var isChildActive = menuSection.Children.Any(c => string.Equals(c.Controller, currentController, StringComparison.OrdinalIgnoreCase));
                var sectionId = $"menu-{menuSection.Title.Replace(" ", "-").ToLower()}";
                
                <!-- Section with children -->
                <div class="nav-section @(isChildActive ? "active" : "")">
                    <div class="nav-section-title d-flex justify-content-between align-items-center cursor-pointer" 
                         onclick="toggleMenuSection(this)">
                        <span>@(menuSection.Title)</span>
                        <i class="fas fa-chevron-right transition-icon @(isChildActive ? "rotate-90" : "")"></i>
                    </div>
                    <div class="nav-children @(isChildActive ? "" : "d-none-soft")">
                        @foreach (var item in menuSection.Children)
                        {
                            var isActive = string.Equals(item.Controller, currentController, StringComparison.OrdinalIgnoreCase);
                            <a asp-controller="@item.Controller" asp-action="@item.Action" 
                               class="nav-link nav-link-child @(isActive ? "active" : "")">
                                <i class="@(item.Icon ?? "fas fa-circle")"></i>
                                <span>@(item.Title)</span>
                            </a>
                        }
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(menuSection.Controller))
            {
                <!-- Standalone page -->
                var isStandaloneActive = string.Equals(menuSection.Controller, currentController, StringComparison.OrdinalIgnoreCase);
                <div class="nav-section">
                    <a asp-controller="@menuSection.Controller" asp-action="@menuSection.Action" 
                       class="nav-link @(isStandaloneActive ? "active" : "")">
                        <i class="@(menuSection.Icon ?? "fas fa-circle")"></i>
                        <span>@(menuSection.Title)</span>
                    </a>
                </div>
            }
        }

        <script>
            function toggleMenuSection(element) {
                const section = $(element).parent();
                const children = section.find('.nav-children');
                const icon = $(element).find('.transition-icon');
                
                // If this section is already open, close it
                if (children.is(':visible')) {
                    children.slideUp(200);
                    icon.removeClass('rotate-90');
                } else {
                    // Close all other sections
                    $('.nav-children').slideUp(200);
                    $('.transition-icon').removeClass('rotate-90');
                    
                    // Open this section
                    children.slideDown(200);
                    icon.addClass('rotate-90');
                }
            }
        </script>
        
        <!-- User Section (always at bottom) -->
        <div class="nav-section">
            <form asp-controller="Account" asp-action="Logout" method="post" id="logoutForm" class="d-none">
            </form>
            <a href="#" onclick="document.getElementById('logoutForm').submit(); return false;" class="nav-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </nav>
</aside>
