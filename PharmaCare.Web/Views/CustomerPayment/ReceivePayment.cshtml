@model PharmaCare.Domain.Entities.Finance.Payment
@inject PharmaCare.Infrastructure.Interfaces.IComboboxRepository _combobox
@{
    ViewData["Title"] = "Receive Payment";
    var sale = ViewBag.Sale as PharmaCare.Domain.Entities.Transactions.StockMain;
}

<!-- Page Header -->
<div class="page-header">
    <h4 class="page-title">
        <i class="fas fa-hand-holding-usd"></i>
        Receive Payment
    </h4>
    <div class="ms-auto">
        <a asp-action="PendingSales" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Pending Sales
        </a>
    </div>
</div>

<div class="row">
    <!-- Sale Details -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-file-invoice"></i> Sale Details</h5>
            </div>
            <div class="card-body">
                @if (sale != null)
                {
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td><strong>Transaction No:</strong></td>
                            <td>@sale.TransactionNo</td>
                        </tr>
                        <tr>
                            <td><strong>Date:</strong></td>
                            <td>@sale.TransactionDate.ToString("dd/MM/yyyy")</td>
                        </tr>
                        <tr>
                            <td><strong>Customer:</strong></td>
                            <td>@sale.Party?.Name</td>
                        </tr>
                        <tr>
                            <td><strong>Total Amount:</strong></td>
                            <td>@sale.TotalAmount.ToString("N2")</td>
                        </tr>
                        <tr>
                            <td><strong>Paid Amount:</strong></td>
                            <td class="text-success">@sale.PaidAmount.ToString("N2")</td>
                        </tr>
                        <tr>
                            <td><strong>Balance:</strong></td>
                            <td><span class="badge bg-danger fs-6">@sale.BalanceAmount.ToString("N2")</span></td>
                        </tr>
                    </table>
                }
            </div>
        </div>
    </div>

    <!-- Payment Form -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Payment Details</h5>
            </div>
            <div class="card-body">
                <form asp-action="ReceivePayment" method="post">
                    <input type="hidden" asp-for="StockMain_ID" />
                    <input type="hidden" asp-for="Party_ID" />

                    <div asp-validation-summary="All" class="text-danger mb-3"></div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="PaymentDate" class="form-label">Payment Date <span class="text-danger">*</span></label>
                            <input asp-for="PaymentDate" type="date" class="form-control" required />
                            <span asp-validation-for="PaymentDate" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="PaymentMethod" class="form-label">Payment Method <span class="text-danger">*</span></label>
                            <select asp-for="PaymentMethod" asp-items="@ViewBag.PaymentMethods" class="form-select" required>
                            </select>
                            <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="Account_ID" class="form-label">Receive Into Account <span class="text-danger">*</span></label>
                            <select asp-for="Account_ID" asp-items="_combobox.GetCashBankAccounts()" class="form-select" required>
                                <option value="">-- Select Account --</option>
                            </select>
                            <span asp-validation-for="Account_ID" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Amount" class="form-label">Amount <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">PKR</span>
                                <input asp-for="Amount" type="number" step="0.01" min="0.01" 
                                       max="@(sale?.BalanceAmount ?? 0)" class="form-control" required />
                            </div>
                            <span asp-validation-for="Amount" class="text-danger"></span>
                            <small class="text-muted">Max: @(sale?.BalanceAmount.ToString("N2") ?? "0.00")</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Remarks" class="form-label">Remarks</label>
                        <textarea asp-for="Remarks" class="form-control" rows="2" placeholder="Optional notes..."></textarea>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a asp-action="PendingSales" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i> Receive Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @* <partial name="_ValidationScriptsPartial" /> *@
    <script>
        $(document).ready(function() {
            // Set max amount based on balance
            var maxAmount = @(sale?.BalanceAmount ?? 0);
            $('#Amount').attr('max', maxAmount);
            
            // Prevent exceeding max
            $('#Amount').on('change', function() {
                var val = parseFloat($(this).val());
                if (val > maxAmount) {
                    $(this).val(maxAmount);
                }
            });
        });
    </script>
}
