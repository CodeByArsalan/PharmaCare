@model PharmaCare.Domain.Models.SaleManagement.SalesReturn
@inject PharmaCare.Infrastructure.Interfaces.IComboBoxRepository _comboBox
@{
    ViewData["Title"] = "Process Sales Return";
    var sale = ViewBag.Sale as PharmaCare.Domain.Models.SaleManagement.Sale;
}

<div class="container-fluid p-0">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas fa-undo-alt me-2"></i>Process Sales Return</h4>
        <a href="@Url.Action("SelectSale")" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back
        </a>
    </div>

    <form asp-action="AddSalesReturn" method="post" id="returnForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Sale_ID" />
        <input type="hidden" asp-for="Store_ID" />

        <div class="row">
            <!-- Sale Info -->
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Original Sale</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Sale #:</strong> @sale?.SaleNumber</p>
                        <p><strong>Date:</strong> @sale?.SaleDate.ToString("dd-MMM-yyyy HH:mm")</p>
                        <p><strong>Customer:</strong> @(sale?.Party?.PartyName ?? "Walk-in")</p>
                        <p><strong>Total:</strong> <span class="fw-bold">@sale?.Total.ToString("N2")</span></p>
                    </div>
                </div>

                <!-- Return Details -->
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Return Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Return Reason</label>
                            <select asp-for="ReturnReason" asp-items="@_comboBox.GetReturnReasons()" class="form-select"
                                required>
                                <option value="">Select Reason</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Refund Method</label>
                            <select asp-for="RefundMethod" asp-items="@_comboBox.GetRefundMethods()" class="form-select"
                                required>
                                <option value="">Select Method</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items to Return -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Select Items to Return</h5>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-bordered table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAll" onclick="toggleAll(this)" />
                                    </th>
                                    <th>Product</th>
                                    <th>Batch</th>
                                    <th class="text-center">Sold Qty</th>
                                    <th class="text-center" style="width: 100px;">Return Qty</th>
                                    <th class="text-end">Unit Price</th>
                                    <th class="text-end">Amount</th>
                                    <th class="text-center">Restock</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (sale?.SaleLines != null)
                                {
                                    var index = 0;
                                    foreach (var line in sale.SaleLines)
                                    {
                                        <tr class="return-line" data-price="@line.UnitPrice">
                                            <td>
                                                <input type="checkbox" class="item-check" onchange="toggleItem(this, @index)" />
                                            </td>
                                            <td>@line.Product?.ProductName</td>
                                            <td>@line.ProductBatch?.BatchNumber</td>
                                            <td class="text-center">@line.Quantity</td>
                                            <td>
                                                <input type="number" name="ReturnLines[@index].Quantity"
                                                    class="form-control form-control-sm qty-input text-center" value="0" min="0"
                                                    max="@line.Quantity" disabled onchange="calculateAmount(@index)" />
                                                <input type="hidden" name="ReturnLines[@index].SaleLine_ID"
                                                    value="@line.SaleLineID" />
                                                <input type="hidden" name="ReturnLines[@index].Product_ID"
                                                    value="@line.Product_ID" />
                                                <input type="hidden" name="ReturnLines[@index].ProductBatch_ID"
                                                    value="@line.ProductBatch_ID" />
                                                <input type="hidden" name="ReturnLines[@index].UnitPrice"
                                                    value="@line.UnitPrice" />
                                            </td>
                                            <td class="text-end">@line.UnitPrice.ToString("N2")</td>
                                            <td class="text-end amount-cell">0.00</td>
                                            <td class="text-center">
                                                <input type="checkbox" name="ReturnLines[@index].RestockInventory" value="true"
                                                    checked disabled class="form-check-input restock-check" />
                                            </td>
                                        </tr>
                                        index++;
                                    }
                                }
                            </tbody>
                            <tfoot class="table-warning">
                                <tr>
                                    <td colspan="6" class="text-end fw-bold">Total Refund:</td>
                                    <td class="text-end fw-bold text-danger fs-5" id="totalRefund">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-danger btn-lg" onclick="return validateReturn()">
                <i class="fas fa-undo-alt me-1"></i> Process Return
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        function toggleAll(checkbox) {
            document.querySelectorAll('.item-check').forEach((cb, idx) => {
                cb.checked = checkbox.checked;
                toggleItem(cb, idx);
            });
        }

        function toggleItem(checkbox, index) {
            const row = checkbox.closest('tr');
            const qtyInput = row.querySelector('.qty-input');
            const restockCheck = row.querySelector('.restock-check');

            if (checkbox.checked) {
                qtyInput.disabled = false;
                restockCheck.disabled = false;
                qtyInput.value = qtyInput.max;
            } else {
                qtyInput.disabled = true;
                restockCheck.disabled = true;
                qtyInput.value = 0;
            }
            calculateAmount(index);
        }

        function calculateAmount(index) {
            const rows = document.querySelectorAll('.return-line');
            const row = rows[index];
            const price = parseFloat(row.dataset.price);
            const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
            const amount = price * qty;
            row.querySelector('.amount-cell').textContent = amount.toFixed(2);

            // Add hidden field for amount
            let amountInput = row.querySelector('input[name$=".Amount"]');
            if (!amountInput) {
                amountInput = document.createElement('input');
                amountInput.type = 'hidden';
                amountInput.name = `ReturnLines[${index}].Amount`;
                row.querySelector('td:last-child').appendChild(amountInput);
            }
            amountInput.value = amount;

            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.amount-cell').forEach(cell => {
                total += parseFloat(cell.textContent) || 0;
            });
            document.getElementById('totalRefund').textContent = total.toFixed(2);
        }

        function validateReturn() {
            const checkedItems = document.querySelectorAll('.item-check:checked');
            if (checkedItems.length === 0) {
                alert('Please select at least one item to return.');
                return false;
            }

            const total = parseFloat(document.getElementById('totalRefund').textContent);
            if (total <= 0) {
                alert('Return amount must be greater than zero.');
                return false;
            }

            return confirm(`Process return for total refund of ${total.toFixed(2)}?`);
        }
    </script>
}
