@model List<PharmaCare.Application.DTOs.Security.RolePagePermissionDTO>
@{
    ViewData["Title"] = "Manage Permissions";
    var role = ViewBag.Role as PharmaCare.Domain.Entities.Security.Role;
    var parents = Model.Where(p => !p.ParentId.HasValue).OrderBy(p => p.DisplayOrder).ToList();
}



<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-bold text-dark mb-1">
            <i class="fas fa-user-shield text-primary me-2"></i>Permissions
        </h4>
        <p class="text-muted mb-0">Manage access for role: <span class="fw-semibold text-dark">@role?.Name</span></p>
    </div>
    
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="collapseAll">
            <i class="fas fa-compress-alt me-1"></i>Collapse All
        </button>
        <button type="button" class="btn btn-outline-primary btn-sm" id="expandAll">
            <i class="fas fa-expand-alt me-1"></i>Expand All
        </button>
        <a asp-action="RolesIndex" class="btn btn-secondary ms-2">
            <i class="fas fa-arrow-left me-2"></i>Back
        </a>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show shadow-sm border-0 border-start border-success border-3" role="alert">
        <i class="fas fa-check-circle text-success me-2"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<form asp-action="SavePermissions" method="post" id="permissionForm">
    <input type="hidden" name="roleId" value="@role?.RoleID" />

    <div class="row">
        @foreach (var parent in parents)
        {
            var parentIndex = Model.IndexOf(parent);
            var children = Model.Where(p => p.ParentId == parent.PageId).OrderBy(p => p.DisplayOrder).ToList();
            var hasChildren = children.Any();

            <div class="col-12">
                <div class="card permission-module-card">
                    <!-- Module Header -->
                    <div class="module-header d-flex justify-content-between align-items-center cursor-pointer toggle-module py-3 px-4" 
                         data-bs-target="#module-@parent.PageId">
                        
                        <!-- Left: Parent Toggle -->
                        <div class="d-flex align-items-center">
                            <i class="fas fa-chevron-down text-muted me-3 transition-icon"></i>
                            <!-- Parent Toggle -->
                            <div class="form-check mb-0">
                                <input type="hidden" name="permissions[@parentIndex].PageId" value="@parent.PageId" />
                                
                                <input class="form-check-input parent-toggle stop-propagation" type="checkbox" 
                                       name="permissions[@parentIndex].CanView" value="true"
                                       id="parent-view-@parentIndex" @(parent.CanView ? "checked" : "")
                                       data-module-id="@parent.PageId">
                                <label class="form-check-label fw-bold text-dark ms-2 stop-propagation" for="parent-view-@parentIndex">
                                    @parent.PageTitle
                                </label>
                            </div>
                        </div>

                        <!-- Right: Actions -->
                        <div class="d-flex align-items-center">
                            <!-- Select All Switch -->
                            <div class="form-check me-4 mb-0">
                                <input class="form-check-input select-all-module stop-propagation" type="checkbox" 
                                       id="select-all-@parentIndex" data-module-id="@parent.PageId">
                                <label class="form-check-label text-muted small stop-propagation" for="select-all-@parentIndex">
                                    Select All
                                </label>
                            </div>

                            <!-- Hidden inputs -->
                            <div class="d-none">
                                <input type="checkbox" name="permissions[@parentIndex].CanCreate" value="true" @(parent.CanCreate ? "checked" : "")>
                                <input type="checkbox" name="permissions[@parentIndex].CanEdit" value="true" @(parent.CanEdit ? "checked" : "")>
                                <input type="checkbox" name="permissions[@parentIndex].CanDelete" value="true" @(parent.CanDelete ? "checked" : "")>
                            </div>

                            @if (hasChildren)
                            {
                                <span class="badge bg-light text-dark border">@children.Count pages</span>
                            }
                        </div>
                    </div>

                    <!-- Module Content (Table) -->
                    @if (hasChildren)
                    {
                        <div class="collapse show" id="module-@parent.PageId">
                            <div class="table-responsive">
                                <table class="table table-permissions">
                                    <thead>
                                        <tr>
                                            <th class="w-40pct ps-5">Page Name</th>
                                            <th class="text-center w-15pct">View</th>
                                            <th class="text-center w-15pct">Create</th>
                                            <th class="text-center w-15pct">Edit</th>
                                            <th class="text-center w-15pct">Delete</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var child in children)
                                        {
                                            var childIndex = Model.IndexOf(child);
                                            <tr>
                                                <td class="ps-5">
                                                    <input type="hidden" name="permissions[@childIndex].PageId" value="@child.PageId" />
                                                    <span class="fw-medium">@child.PageTitle</span>
                                                </td>
                                                
                                                <!-- View -->
                                                <td class="text-center">
                                                    <div class="form-check d-inline-block">
                                                        <input class="form-check-input perm-view" type="checkbox" 
                                                               name="permissions[@childIndex].CanView" value="true"
                                                               id="p-@childIndex-view" @(child.CanView ? "checked" : "")>
                                                    </div>
                                                </td>
                                                
                                                <!-- Create -->
                                                <td class="text-center">
                                                    <div class="form-check d-inline-block">
                                                        <input class="form-check-input perm-action" type="checkbox" 
                                                               name="permissions[@childIndex].CanCreate" value="true"
                                                               id="p-@childIndex-create" @(child.CanCreate ? "checked" : "")>
                                                    </div>
                                                </td>
                                                
                                                <!-- Edit -->
                                                <td class="text-center">
                                                    <div class="form-check d-inline-block">
                                                        <input class="form-check-input perm-action" type="checkbox" 
                                                               name="permissions[@childIndex].CanEdit" value="true"
                                                               id="p-@childIndex-edit" @(child.CanEdit ? "checked" : "")>
                                                    </div>
                                                </td>
                                                
                                                <!-- Delete -->
                                                <td class="text-center">
                                                    <div class="form-check d-inline-block">
                                                        <input class="form-check-input perm-action" type="checkbox" 
                                                               name="permissions[@childIndex].CanDelete" value="true"
                                                               id="p-@childIndex-delete" @(child.CanDelete ? "checked" : "")>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
    
    <!-- Spacer -->
    <div style="height: 60px;"></div>

    <!-- Sticky Footer -->
    <div class="sticky-actions">
        <div class="container-fluid d-flex justify-content-end align-items-center">
            <button type="button" class="btn btn-link text-muted text-decoration-none me-3" onclick="history.back()">Cancel</button>
            <button type="submit" class="btn btn-primary px-4 btn-lg shadow-sm">
                <i class="fas fa-save me-2"></i>Save Changes
            </button>
        </div>
    </div>
</form>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 0. Initialize Select All State on Load
            document.querySelectorAll('.select-all-module').forEach(selectAllCb => {
                const moduleId = selectAllCb.dataset.moduleId;
                const moduleContainer = document.getElementById('module-' + moduleId);
                if (moduleContainer) {
                    const allChildCheckboxes = moduleContainer.querySelectorAll('input[type="checkbox"]');
                    if (allChildCheckboxes.length > 0) {
                        const allChecked = Array.from(allChildCheckboxes).every(cb => cb.checked);
                        selectAllCb.checked = allChecked;
                    }
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            // 1. Dependency Logic: Unchecking 'View' unchecks actions
            document.querySelectorAll('.perm-view').forEach(cb => {
                cb.addEventListener('change', function() {
                    if (!this.checked) {
                        const row = this.closest('tr');
                        row.querySelectorAll('.perm-action').forEach(a => a.checked = false);
                    }
                    updateSelectAllState(this);
                });
            });

            // 2. Dependency Logic: Checking any Action checks 'View'
            document.querySelectorAll('.perm-action').forEach(cb => {
                cb.addEventListener('change', function() {
                    if (this.checked) {
                        const row = this.closest('tr');
                        const viewCb = row.querySelector('.perm-view');
                        if(viewCb) viewCb.checked = true;
                    }
                    updateSelectAllState(this);
                });
            });

            // 3. Parent Toggle Logic (Enable/Disable Module)
            document.querySelectorAll('.parent-toggle').forEach(parentCb => {
                parentCb.addEventListener('change', function() {
                    const moduleId = this.dataset.moduleId;
                    const moduleContainer = document.getElementById('module-' + moduleId);
                    
                    if(moduleContainer) {
                        if(!this.checked) {
                            moduleContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                            
                            // Also uncheck Select All
                            const selectAllCb = document.querySelector(`.select-all-module[data-module-id="${moduleId}"]`);
                            if(selectAllCb) selectAllCb.checked = false;
                        }
                    }
                });
            });

            // 4. Select All Logic
            document.querySelectorAll('.select-all-module').forEach(selectAllCb => {
                selectAllCb.addEventListener('change', function() {
                    const moduleId = this.dataset.moduleId;
                    const moduleContainer = document.getElementById('module-' + moduleId);
                    
                    if (moduleContainer) {
                        const allChildCheckboxes = moduleContainer.querySelectorAll('input[type="checkbox"]');
                        allChildCheckboxes.forEach(cb => cb.checked = this.checked);

                        // If checking Select All, ensure Parent View is also checked
                        if (this.checked) {
                            const parentViewCb = document.querySelector(`.parent-toggle[data-module-id="${moduleId}"]`);
                            if (parentViewCb && !parentViewCb.checked) {
                                parentViewCb.checked = true;
                                // We might need to manually trigger change if we had logic attached to it, 
                                // but here we just need visually checked.
                            }
                        }
                    }
                });
            });

            // Helper to update "Select All" state based on children
            function updateSelectAllState(childCheckbox) {
                const moduleContainer = childCheckbox.closest('.collapse');
                if (!moduleContainer) return;
                
                const moduleId = moduleContainer.id.replace('module-', '');
                const selectAllCb = document.querySelector(`.select-all-module[data-module-id="${moduleId}"]`);
                
                if (selectAllCb) {
                    const allChildCheckboxes = moduleContainer.querySelectorAll('input[type="checkbox"]');
                    const allChecked = Array.from(allChildCheckboxes).every(cb => cb.checked);
                    selectAllCb.checked = allChecked;
                }
            }

            // 5. Expand/Collapse
            document.querySelectorAll('.toggle-module').forEach(header => {
                header.addEventListener('click', function(e) {
                    // Prevent toggle when clicking the switch inside header
                    if (e.target.closest('.stop-propagation')) return;

                    const targetId = this.dataset.bsTarget;
                    const target = document.querySelector(targetId);
                    const bsCollapse = new bootstrap.Collapse(target, { toggle: true });
                    
                    // Rotate Icon
                    const icon = this.querySelector('.transition-icon');
                    if (target.classList.contains('show')) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-right');
                    } else {
                         // It's about to show
                    }
                    
                    // Bootstrap collapse events handl icon rotation better, but simplistic approach:
                    target.addEventListener('shown.bs.collapse', () => {
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-down');
                    });
                    target.addEventListener('hidden.bs.collapse', () => {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-right');
                    });
                });
            });

            // Global Collapse/Expand
             document.getElementById('expandAll').addEventListener('click', () => {
                document.querySelectorAll('.collapse').forEach(el => new bootstrap.Collapse(el, { show: true }));
            });
            document.getElementById('collapseAll').addEventListener('click', () => {
                document.querySelectorAll('.collapse').forEach(el => new bootstrap.Collapse(el, { hide: true }));
            });
        });
    </script>
}
