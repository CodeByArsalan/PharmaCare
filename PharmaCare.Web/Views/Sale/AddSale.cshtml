@model PharmaCare.Domain.Entities.Transactions.StockMain
@inject PharmaCare.Infrastructure.Interfaces.IComboboxRepository _combobox
@{
    ViewData["Title"] = "Add Sale";
}

<!-- Select2 CSS for searchable dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />


<!-- Page Header -->
<div class="page-header">
    <h4 class="page-title">
        <i class="fas fa-plus-circle"></i>
        Add Sale
    </h4>
    <a asp-action="SalesIndex" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to List
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form asp-action="AddSale" method="post" id="saleForm">
            <!-- Header Section -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label">Customer <span class="text-danger">*</span></label>
                    <select asp-for="Party_ID" asp-items="@_combobox.GetActivePartiesByType("Customer")" class="form-select" id="customerSelect" required>
                        <option value="">-- Select Customer --</option>
                    </select>
                    <span asp-validation-for="Party_ID" class="text-danger small"></span>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date <span class="text-danger">*</span></label>
                    <input asp-for="TransactionDate" type="date" class="form-control" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Price Type</label>
                    <select id="priceTypeSelect" class="form-select">
                        @foreach (var type in _combobox.GetPriceTypes())
                        {
                            <option value="@type.Value">@type.Text</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Remarks</label>
                    <input asp-for="Remarks" class="form-control" placeholder="Optional remarks" />
                </div>
            </div>

            <!-- Line Items Section -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Line Items</h6>
                    <button type="button" class="btn btn-sm btn-primary" id="addLineBtn">
                        <i class="fas fa-plus me-1"></i>Add Item
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0">
                            <thead>
                                <tr>
                                    <th class="w-50px">#</th>
                                    <th class="w-min-150px">Product <span class="text-danger">*</span></th>
                                    <th class="w-125px">Quantity <span class="text-danger">*</span></th>
                                    <th class="w-140px">Unit Price <span class="text-danger">*</span></th>
                                    <th class="w-140px">Line Total</th>
                                    <th class="w-100px">Margin %</th>
                                    <th class="w-50px"></th>
                                </tr>
                            </thead>
                            <tbody id="lineItemsBody">
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" class="text-end"><strong>Sub Total:</strong></td>
                                    <td class="text-end"><strong id="subTotalDisplay">0.00</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Totals & Payment Section -->
            <div class="row g-3 mb-4">
                <div class="col-md-6 offset-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">Discount %</label>
                                    <input asp-for="DiscountPercent" type="number" step="0.01" min="0" max="100" 
                                           class="form-control" id="discountPercent" value="0" />
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Discount Amount</label>
                                    <input asp-for="DiscountAmount" type="number" step="1" min="0" 
                                           class="form-control" id="discountAmount" value="0" />
                                </div>
                                <div class="col-12">
                                    <hr class="my-2" />
                                    <div class="d-flex justify-content-between mb-2">
                                        <strong>Total Amount:</strong>
                                        <strong class="text-info fs-5" id="totalAmountDisplay">0.00</strong>
                                    </div>
                                    <input type="hidden" asp-for="SubTotal" id="subTotal" />
                                    <input type="hidden" asp-for="TotalAmount" id="totalAmount" />
                                </div>
                                <div class="col-12">
                                    <hr class="my-2" />
                                    <h6 class="text-muted mb-2"><i class="fas fa-money-bill-wave me-1"></i>Payment</h6>
                                </div>
                                <div class="col-5">
                                    <label class="form-label">Amount Received</label>
                                    <input asp-for="PaidAmount" type="number" step="1" min="0" 
                                           class="form-control" id="paidAmount" value="0" />
                                </div>
                                <div class="col-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-success btn-sm" id="payFullBtn" title="Pay Full Amount">
                                        <i class="fas fa-coins"></i>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Balance</label>
                                    <input type="number" class="form-control" id="balanceDisplay" 
                                           readonly value="0.00" step="1" />
                                    <input type="hidden" asp-for="BalanceAmount" id="balanceAmount" />
                                </div>

                                <!-- Payment Account Selection (shown when payment is made) -->
                                <div class="col-12 mt-2 d-none-soft" id="paymentAccountSection">
                                    <label class="form-label">Payment Account <span class="text-danger">*</span></label>
                                    <select name="PaymentAccountId" id="paymentAccountId" class="form-select">
                                        <option value="">-- Select Payment Account --</option>
                                        @foreach (var account in _combobox.GetCashBankAccounts())
                                        {
                                            <option value="@account.Value">@account.Text</option>
                                        }
                                    </select>
                                    <small class="text-muted">Select Cash or Bank account to receive payment</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Status Banner -->
            <div class="row mb-3">
                <div class="col-md-6 offset-md-6">
                    <div class="alert py-2 mb-0" id="paymentStatusAlert">
                        <span id="paymentStatusText"></span>
                    </div>
                </div>
            </div>

            <div class="text-end">
                <a asp-action="SalesIndex" class="btn btn-outline-secondary me-2">Cancel</a>
                <button type="button" class="btn btn-primary" id="confirmSaveBtn">
                    <i class="fas fa-save me-2"></i>Save Sale
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmSaleModal" tabindex="-1" aria-labelledby="confirmSaleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="confirmSaleModalLabel"><i class="fas fa-check-circle me-2"></i>Confirm Sale</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Customer:</strong> <span id="confirmCustomer">-</span>
                    </div>
                    <div class="col-6">
                        <strong>Date:</strong> <span id="confirmDate">-</span>
                    </div>
                </div>
                <hr/>
                <h6><i class="fas fa-list me-2"></i>Line Items</h6>
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="confirmItemsBody"></tbody>
                </table>
                <hr/>
                <div class="row">
                    <div class="col-6">
                        <div class="d-flex justify-content-between">
                            <span>Sub Total:</span>
                            <strong id="confirmSubTotal">0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between text-danger">
                            <span>Discount:</span>
                            <strong id="confirmDiscount">0.00</strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex justify-content-between fs-5 text-primary">
                            <strong>Total:</strong>
                            <strong id="confirmTotal">0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Paid:</span>
                            <strong id="confirmPaid">0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Balance:</span>
                            <strong id="confirmBalance">0.00</strong>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="finalSubmitBtn">
                    <i class="fas fa-check me-2"></i>Confirm & Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        let products = [];
        let rowIndex = 0;

        document.addEventListener('DOMContentLoaded', function() {
            fetchProducts();
            
            // Event listener for Price Type change
            document.getElementById('priceTypeSelect').addEventListener('change', function() {
                fetchProducts();
            });
            
            // Initialize payment status
            setTimeout(function() {
                calculatePayment();
            }, 100);
        });

        async function fetchProducts() {
            const priceTypeId = document.getElementById('priceTypeSelect').value;
            const url = '@Url.Action("GetProducts")' + (priceTypeId ? `?priceTypeId=${priceTypeId}` : '');
            
            try {
                const response = await fetch(url);
                products = await response.json();
                
                // Update prices in existing rows
                updateExistingRowsPrices();

                // Ensure at least one row exists on load
                if (rowIndex === 0) {
                    addLineItem();
                }
            } catch (error) {
                console.error('Error fetching products:', error);
            }
        }
        
        function updateExistingRowsPrices() {
            const rows = document.querySelectorAll('#lineItemsBody tr');
            rows.forEach(row => {
                const select = row.querySelector('.product-select');
                const selectedProductId = select.value;
                
                // Update dataset on option (optional, as we use global list now, but good for consistency)
                // Note: Re-populating options might be overkill, we just update the current value
                
                if (selectedProductId) {
                    const product = products.find(p => p.id == selectedProductId);
                    if (product) {
                        // Update price input
                        row.querySelector('.price-input').value = product.unitPrice.toFixed(2);
                    }
                }
                
                // Re-populate options for all dropdowns to reflect new prices in data attributes
                // This ensures if user changes product, they get new price
                const currentVal = select.value;
                let productOptions = '<option value="">-- Select Product --</option>';
                products.forEach(p => {
                    const selected = currentVal == p.id ? 'selected' : '';
                    const stockText = p.stockQuantity !== undefined ? ` (Stock: ${p.stockQuantity})` : '';
                    productOptions += `<option value="${p.id}" data-price="${p.unitPrice}" data-cost="${p.costPrice || p.unitPrice}" data-stock="${p.stockQuantity || 0}" ${selected}>${p.name}${stockText}</option>`;
                });
                
                // Save current selection, update HTML, restore selection (Select2 needs re-init or update)
                select.innerHTML = productOptions;
                
                // Re-trigger calculation
                calculateLineTotal({ target: row.querySelector('.quantity-input') });
            });
        }

        document.getElementById('addLineBtn').addEventListener('click', function() { addLineItem(); });

        // Customer change handler - check for counter party
        document.getElementById('customerSelect').addEventListener('change', function() {
            checkCounterParty();
        });

        // Check if selected customer is a counter party (name contains 'Counter')
        function checkCounterParty() {
            const customerSelect = document.getElementById('customerSelect');
            const selectedOption = customerSelect.options[customerSelect.selectedIndex];
            const customerName = selectedOption ? selectedOption.text : '';
            const paidAmountInput = document.getElementById('paidAmount');
            
            // Check if customer name contains 'Counter' (case-insensitive)
            const isCounterParty = customerName.toLowerCase().includes('counter');
            
            if (isCounterParty) {
                // Counter party: Paid = Total, readonly, payment account required
                paidAmountInput.readOnly = true;
                paidAmountInput.style.backgroundColor = 'var(--bg-elevated)';
                paidAmountInput.style.color = 'var(--text-primary)';
                paidAmountInput.title = 'Counter customer - full payment required';
            } else {
                // Regular party: Paid is editable
                paidAmountInput.readOnly = false;
                paidAmountInput.style.backgroundColor = '';
                paidAmountInput.style.color = '';
                paidAmountInput.title = '';
            }
            
            // Recalculate totals to apply paid amount logic
            calculateTotals();
        }
        
        // Helper to check if current customer is counter party
        function isCurrentCustomerCounter() {
            const customerSelect = document.getElementById('customerSelect');
            const selectedOption = customerSelect.options[customerSelect.selectedIndex];
            const customerName = selectedOption ? selectedOption.text : '';
            return customerName.toLowerCase().includes('counter');
        }

        function addLineItem(detail = null) {
            const tbody = document.getElementById('lineItemsBody');
            const row = document.createElement('tr');
            
            let productOptions = '<option value="">-- Select Product --</option>';
            products.forEach(p => {
                const selected = detail && detail.productId === p.id ? 'selected' : '';
                const stockText = p.stockQuantity !== undefined ? ` (Stock: ${p.stockQuantity})` : '';
                productOptions += `<option value="${p.id}" data-price="${p.unitPrice}" data-cost="${p.costPrice || p.unitPrice}" data-stock="${p.stockQuantity || 0}" ${selected}>${p.name}${stockText}</option>`;
            });

            const quantity = detail ? detail.quantity : 1;
            const unitPrice = detail ? detail.unitPrice : 0;
            const lineTotal = detail ? detail.lineTotal : 0;

            row.innerHTML = `
                <td class="align-middle">${rowIndex + 1}</td>
                <td>
                    <select name="StockDetails[${rowIndex}].Product_ID" class="form-select product-select" required>
                        ${productOptions}
                    </select>
                </td>
                <td>
                    <input type="number" name="StockDetails[${rowIndex}].Quantity" class="form-control quantity-input" 
                           step="1" min="1" value="${quantity}" required />
                </td>
                <td>
                    <input type="number" name="StockDetails[${rowIndex}].UnitPrice" class="form-control price-input" 
                           step="1" min="0" value="${unitPrice}" required />
                    <input type="hidden" name="StockDetails[${rowIndex}].CostPrice" class="cost-price-input" value="0" />
                </td>
                <td>
                    <input type="number" name="StockDetails[${rowIndex}].LineTotal" class="form-control line-total" 
                           readonly value="${lineTotal}" />
                    <input type="hidden" name="StockDetails[${rowIndex}].LineCost" class="line-cost" value="0" />
                </td>
                <td class="text-center align-middle">
                    <span class="badge bg-success margin-display">--%</span>
                </td>
                <td class="text-center align-middle">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(row);
            
            row.querySelector('.product-select').addEventListener('change', onProductChange);
            row.querySelector('.quantity-input').addEventListener('input', calculateLineTotal);
            row.querySelector('.price-input').addEventListener('input', calculateLineTotal);
            row.querySelector('.remove-row-btn').addEventListener('click', removeRow);

            // Initialize Select2 for searchable product dropdown
            $(row.querySelector('.product-select')).select2({
                theme: 'bootstrap-5',
                placeholder: '-- Select Product --',
                allowClear: true,
                width: '100%'
            }).on('change', onProductChange);

            rowIndex++;
        }

        function onProductChange(e) {
            const row = e.target.closest('tr');
            const selectedOption = e.target.options[e.target.selectedIndex];
            const unitPrice = parseFloat(selectedOption.dataset.price) || 0;
            const costPrice = parseFloat(selectedOption.dataset.cost) || 0;
            
            row.querySelector('.price-input').value = unitPrice.toFixed(2);
            row.querySelector('.cost-price-input').value = costPrice.toFixed(2);
            calculateLineTotal({ target: row.querySelector('.quantity-input') });
        }

        function calculateLineTotal(e) {
            const row = e.target.closest('tr');
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
            const costPrice = parseFloat(row.querySelector('.cost-price-input').value) || 0;
            const lineTotal = quantity * unitPrice;
            const lineCost = quantity * costPrice;
            
            row.querySelector('.line-total').value = lineTotal.toFixed(2);
            row.querySelector('.line-cost').value = lineCost.toFixed(2);
            updateMarginDisplay(row);
            calculateTotals();
        }

        function removeRow(e) {
            const tbody = document.getElementById('lineItemsBody');
            if (tbody.children.length > 1) {
                e.target.closest('tr').remove();
                renumberRows();
                calculateTotals();
            }
        }

        function renumberRows() {
            const rows = document.querySelectorAll('#lineItemsBody tr');
            rows.forEach((row, idx) => {
                row.cells[0].textContent = idx + 1;
                row.querySelector('.product-select').name = `StockDetails[${idx}].Product_ID`;
                row.querySelector('.quantity-input').name = `StockDetails[${idx}].Quantity`;
                row.querySelector('.price-input').name = `StockDetails[${idx}].UnitPrice`;
                row.querySelector('.cost-price-input').name = `StockDetails[${idx}].CostPrice`;
                row.querySelector('.line-total').name = `StockDetails[${idx}].LineTotal`;
                row.querySelector('.line-cost').name = `StockDetails[${idx}].LineCost`;
            });
            rowIndex = rows.length;
        }

        function calculateTotals() {
            const lineTotals = document.querySelectorAll('.line-total');
            let subTotal = 0;
            lineTotals.forEach(input => {
                subTotal += parseFloat(input.value) || 0;
            });

            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const discountAmount = Math.round(subTotal * discountPercent / 100 * 100) / 100;
            const totalAmount = subTotal - discountAmount;

            document.getElementById('subTotalDisplay').textContent = subTotal.toFixed(2);
            document.getElementById('subTotal').value = subTotal.toFixed(2);
            document.getElementById('discountAmount').value = discountAmount.toFixed(2);
            document.getElementById('totalAmountDisplay').textContent = totalAmount.toFixed(2);
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);

            // For counter parties, auto-set Paid = Total
            if (isCurrentCustomerCounter()) {
                document.getElementById('paidAmount').value = totalAmount.toFixed(2);
            }

            // Calculate balance
            calculatePayment();
        }

        // Bi-directional discount: update % when amount changes
        function calculateDiscountFromAmount() {
            const subTotal = parseFloat(document.getElementById('subTotal').value) || 0;
            const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
            
            if (subTotal > 0) {
                const discountPercent = Math.round(discountAmount / subTotal * 100 * 100) / 100;
                document.getElementById('discountPercent').value = discountPercent.toFixed(2);
            } else {
                document.getElementById('discountPercent').value = '0';
            }
            
            const totalAmount = subTotal - discountAmount;
            document.getElementById('totalAmountDisplay').textContent = totalAmount.toFixed(2);
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);
            
            // For counter parties, auto-set Paid = Total
            if (isCurrentCustomerCounter()) {
                document.getElementById('paidAmount').value = totalAmount.toFixed(2);
            }
            
            calculatePayment();
        }

        function calculatePayment() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
            const balance = totalAmount - paidAmount;

            document.getElementById('balanceDisplay').value = balance.toFixed(2);
            document.getElementById('balanceAmount').value = balance.toFixed(2);

            // Show/Hide Payment Account dropdown based on payment
            const paymentSection = document.getElementById('paymentAccountSection');
            if (paidAmount > 0) {
                paymentSection.style.display = 'block';
            } else {
                paymentSection.style.display = 'none';
                document.getElementById('paymentAccountId').value = ''; // Clear selection
            }

            // Update payment status
            const alertDiv = document.getElementById('paymentStatusAlert');
            const statusText = document.getElementById('paymentStatusText');

            if (totalAmount === 0) {
                alertDiv.className = 'alert alert-secondary mb-0 mt-2';
                statusText.innerHTML = '<i class="fas fa-info-circle me-1"></i>Add items to calculate total';
            } else if (paidAmount >= totalAmount) {
                alertDiv.className = 'alert alert-success mb-0 mt-2';
                statusText.innerHTML = '<i class="fas fa-check-circle me-1"></i>Fully Paid';
            } else if (paidAmount > 0) {
                alertDiv.className = 'alert alert-warning mb-0 mt-2';
                statusText.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>Partial Payment - Balance: ' + balance.toFixed(2);
            } else {
                alertDiv.className = 'alert alert-info mb-0 mt-2';
                statusText.innerHTML = '<i class="fas fa-money-bill me-1"></i>No Payment - Credit Sale';
            }
        }

        document.getElementById('discountPercent').addEventListener('input', calculateTotals);
        document.getElementById('paidAmount').addEventListener('input', function() {
            calculatePayment();
        });

        // Pay Full button click handler
        document.getElementById('payFullBtn').addEventListener('click', function() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            document.getElementById('paidAmount').value = totalAmount.toFixed(2);
            calculatePayment();
        });

        // Discount amount change handler (bi-directional)
        document.getElementById('discountAmount').addEventListener('input', calculateDiscountFromAmount);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+N: Add new line item
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                addLineItem();
            }
            // Ctrl+S: Show confirmation modal
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                showConfirmationModal();
            }
        });

        // Confirmation Modal Logic
        document.getElementById('confirmSaveBtn').addEventListener('click', showConfirmationModal);

        function showConfirmationModal() {
            // 1. Custom Validation: Payment Account Required if Paid Amount > 0
            const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
            const paymentAccountId = document.getElementById('paymentAccountId');
            
            if (paidAmount > 0 && !paymentAccountId.value) {
                paymentAccountId.setCustomValidity('Please select a payment account.');
                paymentAccountId.reportValidity();
                
                // Also ensure the section is visible
                document.getElementById('paymentAccountSection').style.display = 'block';
                return;
            } else {
                paymentAccountId.setCustomValidity('');
            }

            // 2. Validate form
            const form = document.getElementById('saleForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // 3. Ensure at least one row
            const rows = document.querySelectorAll('#lineItemsBody tr');
            if (rows.length === 0) {
                alert('Please add at least one product.');
                addLineItem();
                return;
            }

            // Get customer name
            const customerSelect = document.getElementById('customerSelect');
            const customerName = customerSelect.options[customerSelect.selectedIndex]?.text || '-';
            document.getElementById('confirmCustomer').textContent = customerName;

            // Get date
            const dateInput = document.querySelector('input[name="TransactionDate"]');
            document.getElementById('confirmDate').textContent = dateInput.value || '-';

            // Populate line items
            const confirmItemsBody = document.getElementById('confirmItemsBody');
            confirmItemsBody.innerHTML = '';
            const confirmRows = document.querySelectorAll('#lineItemsBody tr');
            confirmRows.forEach((row, idx) => {
                const productName = row.querySelector('.product-select').options[row.querySelector('.product-select').selectedIndex]?.text || '-';
                const qty = row.querySelector('.quantity-input').value || '0';
                const price = row.querySelector('.price-input').value || '0';
                const total = row.querySelector('.line-total').value || '0';
                confirmItemsBody.innerHTML += `<tr><td>${idx + 1}</td><td>${productName.split(' (Stock')[0]}</td><td>${qty}</td><td>${price}</td><td>${total}</td></tr>`;
            });

            // Populate totals
            document.getElementById('confirmSubTotal').textContent = document.getElementById('subTotal').value || '0.00';
            document.getElementById('confirmDiscount').textContent = document.getElementById('discountAmount').value || '0.00';
            document.getElementById('confirmTotal').textContent = document.getElementById('totalAmount').value || '0.00';
            document.getElementById('confirmPaid').textContent = document.getElementById('paidAmount').value || '0.00';
            document.getElementById('confirmBalance').textContent = document.getElementById('balanceAmount').value || '0.00';

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('confirmSaleModal'));
            modal.show();
        }

        // Final submit handler
        document.getElementById('finalSubmitBtn').addEventListener('click', function() {
            document.getElementById('saleForm').submit();
        });

        // Update margin display when price/cost changes
        function updateMarginDisplay(row) {
            const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
            const costPrice = parseFloat(row.querySelector('.cost-price-input').value) || 0;
            const marginDisplay = row.querySelector('.margin-display');
            
            if (unitPrice > 0 && costPrice > 0) {
                const margin = ((unitPrice - costPrice) / unitPrice) * 100;
                marginDisplay.textContent = margin.toFixed(1) + '%';
                marginDisplay.className = margin >= 0 ? 'badge bg-success margin-display' : 'badge bg-danger margin-display';
            } else if (unitPrice > 0) {
                // No cost price set, show as neutral
                marginDisplay.textContent = '--%';
                marginDisplay.className = 'badge bg-secondary margin-display';
            } else {
                marginDisplay.textContent = '--%';
                marginDisplay.className = 'badge bg-secondary margin-display';
            }
        }
    </script>
}
