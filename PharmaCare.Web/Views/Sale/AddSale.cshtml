@model PharmaCare.Domain.Entities.Transactions.StockMain
@inject PharmaCare.Infrastructure.Interfaces.IComboboxRepository _combobox
@{
    ViewData["Title"] = "Add Sale";
    var selectedPaymentAccountId = ViewBag.SelectedPaymentAccountId as int?;
    var selectedPriceTypeId = ViewBag.SelectedPriceTypeId as int?;
    var tenderedAmountValue = ViewBag.TenderedAmount != null
        ? Convert.ToDecimal(ViewBag.TenderedAmount)
        : Model.PaidAmount;
    var walkInCustomerNameValue = ViewBag.WalkInCustomerName as string;
}

<style>
    @@media (max-width: 767.98px) {
        #lineItemsBody tr {
            display: block;
            border: 1px solid var(--glass-border);
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            background: var(--bg-card);
        }

        #lineItemsBody td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border: 0;
        }

        #lineItemsBody td::before {
            content: attr(data-label);
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 88px;
        }

        #lineItemsBody td .form-control,
        #lineItemsBody td .select2-container {
            width: 100% !important;
            max-width: 62%;
        }

        table.table > thead,
        table.table > tfoot {
            display: none;
        }

        .sale-summary-sticky {
            position: sticky;
            bottom: 0;
            z-index: 10;
            box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.15);
        }
    }
</style>


<!-- Page Header -->
<div class="page-header">
    <h4 class="page-title">
        <i class="fas fa-plus-circle"></i>
        Add Sale
    </h4>
    <a asp-action="SalesIndex" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to List
    </a>
</div>

<div class="card">
    <div class="card-body">
        <div asp-validation-summary="All" class="text-danger mb-3"></div>
        <form asp-action="AddSale" method="post" id="saleForm">
            <!-- Header Section -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label">Customer <span class="text-danger">*</span></label>
                    <select asp-for="Party_ID" asp-items="@_combobox.GetActivePartiesByType("Customer")" class="form-select select2-manual" id="customerSelect" required>
                        <option value="">-- Select Customer --</option>
                    </select>
                    <span asp-validation-for="Party_ID" class="text-danger small"></span>
                </div>
                <div class="col-md-3 d-none-soft" id="walkInNameSection">
                    <label class="form-label">Walk-in Name</label>
                    <input type="text"
                           class="form-control"
                           id="walkInCustomerName"
                           name="WalkInCustomerName"
                           value="@walkInCustomerNameValue"
                           placeholder="Walk-in" />
                    <small class="text-muted">Only used when walk-in customer is selected.</small>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date <span class="text-danger">*</span></label>
                    <input asp-for="TransactionDate" type="date" class="form-control" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Price Type</label>
                    <select id="priceTypeSelect" name="PriceTypeId" class="form-select">
                        @foreach (var type in _combobox.GetPriceTypes())
                        {
                            var isSelected = selectedPriceTypeId.HasValue
                                && selectedPriceTypeId.Value.ToString() == type.Value;
                            <option value="@type.Value" selected="@(isSelected ? "selected" : null)">@type.Text</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Remarks</label>
                    <input asp-for="Remarks" class="form-control" placeholder="Optional remarks" />
                </div>
            </div>

            <!-- Line Items Section -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Line Items</h6>
                    <div class="d-flex align-items-center gap-2">
                        <small class="text-muted d-none d-md-inline">Tab on Line Total adds next row</small>
                        <button type="button" class="btn btn-sm btn-primary" id="addLineBtn">
                            <i class="fas fa-plus me-1"></i>Add Item
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0">
                            <thead>
                                <tr>
                                    <th class="w-50px">#</th>
                                    <th class="w-min-150px">Product <span class="text-danger">*</span></th>
                                    <th class="w-125px">Quantity <span class="text-danger">*</span></th>
                                    <th class="w-140px">Unit Price <span class="text-danger">*</span></th>
                                    <th class="w-140px">Line Total</th>
                                    <th class="w-100px">Margin %</th>
                                    <th class="w-50px"></th>
                                </tr>
                            </thead>
                            <tbody id="lineItemsBody">
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" class="text-end"><strong>Sub Total:</strong></td>
                                    <td class="text-end"><strong id="subTotalDisplay">0.00</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Totals & Payment Section -->
            <div class="row g-3 mb-4">
                <div class="col-md-6 offset-md-6">
                    <div class="card sale-summary-sticky">
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">Discount %</label>
                                    <input asp-for="DiscountPercent" type="number" step="0.01" min="0" max="100" 
                                           class="form-control" id="discountPercent" value="0" />
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Discount Amount</label>
                                    <input asp-for="DiscountAmount" type="number" step="0.01" min="0"
                                           class="form-control" id="discountAmount" value="0" />
                                </div>
                                <div class="col-12">
                                    <hr class="my-2" />
                                    <div class="d-flex justify-content-between mb-2">
                                        <strong>Total Amount:</strong>
                                        <strong class="text-info fs-5" id="totalAmountDisplay">0.00</strong>
                                    </div>
                                    <input type="hidden" asp-for="SubTotal" id="subTotal" />
                                    <input type="hidden" asp-for="TotalAmount" id="totalAmount" />
                                </div>
                                <div class="col-12">
                                    <hr class="my-2" />
                                    <h6 class="text-muted mb-2"><i class="fas fa-money-bill-wave me-1"></i>Payment</h6>
                                </div>
                                <div class="col-5">
                                    <label class="form-label">Paid Amount</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0"
                                               class="form-control" id="tenderedAmount" name="TenderedAmount"
                                               value="@tenderedAmountValue.ToString("0.##")" />
                                        <button type="button" class="btn btn-outline-success" id="payFullBtn" title="Pay Full Amount">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                    <input asp-for="PaidAmount" type="hidden" id="paidAmount" value="0" />
                                </div>
                                <div class="col-7">
                                    <div id="balanceContainer">
                                        <label class="form-label">Remaining Due</label>
                                        <input type="number" class="form-control" id="balanceDisplay" 
                                               readonly value="0.00" step="1" />
                                    </div>
                                    <div id="changeContainer" style="display:none;">
                                        <label class="form-label text-success">Change Due</label>
                                        <input type="number" class="form-control border-success text-success fw-bold" id="changeDisplay" 
                                               readonly value="0.00" step="1" />
                                    </div>
                                    <input type="hidden" asp-for="BalanceAmount" id="balanceAmount" />
                                </div>

                                <!-- Payment Account Selection (shown when payment is made) -->
                                <div class="col-12 mt-2 d-none-soft" id="paymentAccountSection">
                                    <label class="form-label">Payment Account <span class="text-danger">*</span></label>
                                    <select name="PaymentAccountId" id="paymentAccountId" class="form-select">
                                        <option value="">-- Select Payment Account --</option>
                                        @foreach (var account in _combobox.GetCashBankAccounts())
                                        {
                                            var isSelected = selectedPaymentAccountId.HasValue
                                                && selectedPaymentAccountId.Value.ToString() == account.Value;
                                            <option value="@account.Value" selected="@(isSelected ? "selected" : null)">@account.Text</option>
                                        }
                                    </select>
                                    <small class="text-muted">Select Cash or Bank account to receive payment</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Status Banner -->
            <div class="row mb-3">
                <div class="col-md-6 offset-md-6">
                    <div class="alert py-2 mb-0" id="paymentStatusAlert">
                        <span id="paymentStatusText"></span>
                    </div>
                    <div class="small text-muted mt-2">
                        <div>You Saved: <strong id="savedAmountCue">0.00</strong></div>
                        <div>Remaining Due: <strong id="remainingDueCue">0.00</strong></div>
                        <div>Customer Status: <strong id="customerOutstandingCue">Loading...</strong></div>
                    </div>
                </div>
            </div>

            <div class="text-end">
                <a asp-action="SalesIndex" class="btn btn-outline-secondary me-2">Cancel</a>
                <button type="button" class="btn btn-primary" id="confirmSaveBtn">
                    <i class="fas fa-save me-2"></i>Save Sale
                </button>
                <div class="text-danger small mt-2 d-none-soft" id="stockErrorHint">
                    Please resolve stock quantity issues before saving.
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmSaleModal" tabindex="-1" aria-labelledby="confirmSaleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="confirmSaleModalLabel"><i class="fas fa-check-circle me-2"></i>Confirm Sale</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Customer:</strong> <span id="confirmCustomer">-</span>
                    </div>
                    <div class="col-6">
                        <strong>Date:</strong> <span id="confirmDate">-</span>
                    </div>
                </div>
                <hr/>
                <h6><i class="fas fa-list me-2"></i>Line Items</h6>
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="confirmItemsBody"></tbody>
                </table>
                <hr/>
                <div class="row">
                    <div class="col-6">
                        <div class="d-flex justify-content-between">
                            <span>Sub Total:</span>
                            <strong id="confirmSubTotal">0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between text-danger">
                            <span>Discount:</span>
                            <strong id="confirmDiscount">0.00</strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex justify-content-between fs-5 text-primary">
                            <strong>Total:</strong>
                            <strong id="confirmTotal">0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Paid Amount:</span>
                            <strong id="confirmTendered">0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Paid (Applied):</span>
                            <strong id="confirmPaid">0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Balance:</span>
                            <strong id="confirmBalance">0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between text-success">
                            <span>Change:</span>
                            <strong id="confirmChange">0.00</strong>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="finalSubmitBtn">
                    <i class="fas fa-check me-2"></i>Confirm & Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let products = [];
        let rowIndex = 0;
        let isPaidAmountAuto = true;
        const HIGH_DISCOUNT_CONFIRM_THRESHOLD = 10;
        let lastDiscountEdit = 'percent'; // Track which discount field was last edited
        const WALKING_CUSTOMER_PATTERN = /(walk[\s-]?in|counter)/i;

        document.addEventListener('DOMContentLoaded', function() {
            initializeCustomerSelect();
            fetchProducts();

            $('#priceTypeSelect').on('change', function() {
                fetchProducts();
            });

            document.getElementById('discountPercent').addEventListener('input', function() {
                lastDiscountEdit = 'percent';
                calculateTotals();
            });
            document.getElementById('discountAmount').addEventListener('input', function() {
                lastDiscountEdit = 'amount';
                calculateDiscountFromAmount();
            });
            document.getElementById('tenderedAmount').addEventListener('input', function() {
                isPaidAmountAuto = false;
                calculatePayment();
            });
            document.getElementById('paymentAccountId').addEventListener('change', function() {
                this.setCustomValidity('');
            });

            document.getElementById('payFullBtn').addEventListener('click', function() {
                isPaidAmountAuto = true;
                const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
                document.getElementById('tenderedAmount').value = totalAmount.toFixed(2);
                calculatePayment();
            });

            document.getElementById('confirmSaveBtn').addEventListener('click', handleSaveClick);
            document.getElementById('finalSubmitBtn').addEventListener('click', function() {
                if (!validateBeforeSubmit()) {
                    return;
                }

                persistLastPaymentAccount();
                submitSaleFormInNewTab();
            });

            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    addLineItem();
                }

                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    handleSaveClick();
                }

                if (e.key === 'Enter') {
                    const target = e.target;
                    if ((target.tagName === 'INPUT' || target.tagName === 'SELECT') && target.type !== 'submit') {
                        e.preventDefault();
                    }
                }
            });

            calculatePayment();
            updateSaveButtonState();
        });

        function initializeCustomerSelect() {
            const customerSelectElement = document.getElementById('customerSelect');
            const customerSelect = $('#customerSelect');

            customerSelect.select2({
                theme: 'bootstrap-5',
                placeholder: '-- Select Customer --',
                allowClear: true,
                width: '100%'
            });

            customerSelect.on('change', function() {
                toggleWalkInNameInput();
                fetchCustomerCreditStatus();
            });

            if (!customerSelectElement.value) {
                const walkInOption = Array.from(customerSelectElement.options)
                    .find(opt => opt.value && WALKING_CUSTOMER_PATTERN.test(opt.text));
                if (walkInOption) {
                    customerSelectElement.value = walkInOption.value;
                }
            }

            customerSelect.trigger('change');
        }

        function toggleWalkInNameInput() {
            const customerSelect = document.getElementById('customerSelect');
            const walkInSection = document.getElementById('walkInNameSection');
            const walkInNameInput = document.getElementById('walkInCustomerName');
            const selectedOption = customerSelect.options[customerSelect.selectedIndex];
            const isWalkIn = selectedOption && selectedOption.value && WALKING_CUSTOMER_PATTERN.test(selectedOption.text || '');

            if (isWalkIn) {
                walkInSection.classList.remove('d-none-soft');
                walkInNameInput.required = true;
                if (!walkInNameInput.value.trim()) {
                    walkInNameInput.value = 'Walk-in';
                }
            } else {
                walkInSection.classList.add('d-none-soft');
                walkInNameInput.required = false;
                walkInNameInput.value = '';
            }
        }

        async function fetchCustomerCreditStatus() {
            const customerId = parseInt(document.getElementById('customerSelect').value || '0', 10);
            const cue = document.getElementById('customerOutstandingCue');

            if (!customerId) {
                cue.textContent = 'No customer selected';
                return;
            }

            try {
                const response = await fetch(`@Url.Action("GetCustomerCreditStatus")?customerId=${customerId}`);
                if (!response.ok) {
                    cue.textContent = 'Unavailable';
                    return;
                }

                const result = await response.json();
                if (result.status === 'Outstanding') {
                    cue.textContent = `Outstanding PKR ${Number(result.outstandingBalance || 0).toFixed(2)} (${result.openInvoices || 0} invoices)`;
                } else {
                    cue.textContent = 'Clear';
                }
            } catch (error) {
                console.error('Failed to load customer status', error);
                cue.textContent = 'Unavailable';
            }
        }

        async function fetchProducts() {
            const priceTypeRaw = document.getElementById('priceTypeSelect').value;
            const priceTypeId = parseInt(priceTypeRaw, 10);
            const url = '@Url.Action("GetProducts")' + (Number.isInteger(priceTypeId) ? `?priceTypeId=${priceTypeId}` : '');
            
            try {
                const response = await fetch(url);
                products = await response.json();
                
                // Update prices in existing rows
                updateExistingRowsPrices();

                // Ensure at least one row exists on load
                if (rowIndex === 0) {
                    addLineItem();
                }
            } catch (error) {
                console.error('Error fetching products:', error);
            }
        }
        
        function updateExistingRowsPrices() {
            const rows = document.querySelectorAll('#lineItemsBody tr');
            rows.forEach(row => {
                const select = row.querySelector('.product-select');
                const selectedProductId = select.value;

                if (selectedProductId) {
                    const product = products.find(p => p.id == selectedProductId);
                    if (product) {
                        row.querySelector('.price-input').value = product.unitPrice.toFixed(2);
                        row.querySelector('.cost-price-input').value = (product.costPrice || product.unitPrice).toFixed(2);
                    }
                }

                const currentVal = select.value;
                let productOptions = '<option value="">-- Select Product --</option>';
                products.forEach(p => {
                    const selected = currentVal == p.id ? 'selected' : '';
                    const stockText = p.stockQuantity !== undefined ? ` (Stock: ${p.stockQuantity})` : '';
                    productOptions += `<option value="${p.id}" data-price="${p.unitPrice}" data-cost="${p.costPrice || p.unitPrice}" data-stock="${p.stockQuantity || 0}" ${selected}>${p.name}${stockText}</option>`;
                });

                select.innerHTML = productOptions;
                $(select).trigger('change.select2');
                calculateLineTotal({ target: row.querySelector('.quantity-input') });
            });
        }

        document.getElementById('addLineBtn').addEventListener('click', function() { addLineItem(); });

        function addLineItem(detail = null) {
            const tbody = document.getElementById('lineItemsBody');
            const row = document.createElement('tr');
            
            let productOptions = '<option value="">-- Select Product --</option>';
            products.forEach(p => {
                const selected = detail && detail.productId === p.id ? 'selected' : '';
                const stockText = p.stockQuantity !== undefined ? ` (Stock: ${p.stockQuantity})` : '';
                productOptions += `<option value="${p.id}" data-price="${p.unitPrice}" data-cost="${p.costPrice || p.unitPrice}" data-stock="${p.stockQuantity || 0}" ${selected}>${p.name}${stockText}</option>`;
            });

            const quantity = detail ? detail.quantity : 1;
            const unitPrice = detail ? detail.unitPrice : 0;
            const lineTotal = detail ? detail.lineTotal : 0;

            row.innerHTML = `
                <td class="align-middle" data-label="#">${rowIndex + 1}</td>
                <td data-label="Product">
                    <select name="StockDetails[${rowIndex}].Product_ID" class="form-select product-select select2-manual" required>
                        ${productOptions}
                    </select>
                </td>
                <td data-label="Quantity">
                    <div class="w-100">
                        <input type="number" name="StockDetails[${rowIndex}].Quantity" class="form-control quantity-input"
                               step="1" min="1" value="${quantity}" required />
                        <div class="invalid-feedback stock-feedback"></div>
                    </div>
                </td>
                <td data-label="Unit Price">
                    <input type="number" name="StockDetails[${rowIndex}].UnitPrice" class="form-control price-input"
                           step="0.01" min="0" value="${unitPrice}" required />
                    <input type="hidden" name="StockDetails[${rowIndex}].CostPrice" class="cost-price-input" value="0" />
                </td>
                <td data-label="Line Total">
                    <input type="number" name="StockDetails[${rowIndex}].LineTotal" class="form-control line-total"
                           readonly value="${lineTotal}" />
                    <input type="hidden" name="StockDetails[${rowIndex}].LineCost" class="line-cost" value="0" />
                </td>
                <td class="text-center align-middle" data-label="Margin">
                    <span class="badge bg-success margin-display">--%</span>
                </td>
                <td class="text-center align-middle" data-label="Remove">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(row);
            
            row.querySelector('.product-select').addEventListener('change', onProductChange);
            row.querySelector('.quantity-input').addEventListener('input', calculateLineTotal);
            row.querySelector('.price-input').addEventListener('input', calculateLineTotal);
            row.querySelector('.line-total').addEventListener('keydown', handleLineTotalTabNavigation);
            row.querySelector('.remove-row-btn').addEventListener('click', removeRow);

            // Initialize Select2 for searchable product dropdown
            const select2 = $(row.querySelector('.product-select')).select2({
                theme: 'bootstrap-5',
                placeholder: '-- Select Product --',
                allowClear: true,
                width: '100%'
            });
            
            select2.on('change', onProductChange);
            
            // Auto-open Select2 if it's a new empty row (optional, improves speed)
            if (!detail) {
                 select2.select2('open');
            }

            rowIndex++;
            updateSaveButtonState();
        }

        function handleLineTotalTabNavigation(e) {
            if (e.key !== 'Tab' || e.shiftKey || e.repeat) {
                return;
            }

            const row = e.target.closest('tr');
            const tbody = document.getElementById('lineItemsBody');
            if (!row || tbody.lastElementChild !== row) {
                return;
            }

            e.preventDefault();
            addLineItem();
        }

        function onProductChange(e) {
            const row = e.target.closest('tr');
            const selectedOption = e.target.options[e.target.selectedIndex];
            const unitPrice = parseFloat(selectedOption.dataset.price) || 0;
            const costPrice = parseFloat(selectedOption.dataset.cost) || 0;
            
            row.querySelector('.price-input').value = unitPrice.toFixed(2);
            row.querySelector('.cost-price-input').value = costPrice.toFixed(2);
            isPaidAmountAuto = true;
            calculateLineTotal({ target: row.querySelector('.quantity-input') });
            
            // Keyboard Optimization: Focus Quantity after selection
            // Small delay to allow Select2 to close properly
            setTimeout(() => {
                const qtyInput = row.querySelector('.quantity-input');
                if(qtyInput) {
                    qtyInput.focus();
                    qtyInput.select();
                }
            }, 100);
        }

        function calculateLineTotal(e) {
            const row = e.target.closest('tr');
            const quantityInput = row.querySelector('.quantity-input');
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
            const costPrice = parseFloat(row.querySelector('.cost-price-input').value) || 0;
            
            const select = row.querySelector('.product-select');
            const selectedOption = select.options[select.selectedIndex];
            const stock = parseFloat(selectedOption.dataset.stock) || 0;
            const feedback = row.querySelector('.stock-feedback');

            if (select.value && quantity > stock) {
                quantityInput.classList.add('is-invalid');
                quantityInput.title = '';
                feedback.textContent = `Insufficient stock. Available: ${stock}`;
            } else {
                quantityInput.classList.remove('is-invalid');
                quantityInput.title = '';
                feedback.textContent = '';
            }

            const lineTotal = quantity * unitPrice;
            const lineCost = quantity * costPrice;
            
            row.querySelector('.line-total').value = lineTotal.toFixed(2);
            row.querySelector('.line-cost').value = lineCost.toFixed(2);
            updateMarginDisplay(row);
            calculateTotals();
            updateSaveButtonState();
        }

        function removeRow(e) {
            const tbody = document.getElementById('lineItemsBody');
            if (tbody.children.length > 1) {
                e.target.closest('tr').remove();
                renumberRows();
                calculateTotals();
            }
            updateSaveButtonState();
        }

        function renumberRows() {
            const rows = document.querySelectorAll('#lineItemsBody tr');
            rows.forEach((row, idx) => {
                row.cells[0].textContent = idx + 1;
                row.querySelector('.product-select').name = `StockDetails[${idx}].Product_ID`;
                row.querySelector('.quantity-input').name = `StockDetails[${idx}].Quantity`;
                row.querySelector('.price-input').name = `StockDetails[${idx}].UnitPrice`;
                row.querySelector('.cost-price-input').name = `StockDetails[${idx}].CostPrice`;
                row.querySelector('.line-total').name = `StockDetails[${idx}].LineTotal`;
                row.querySelector('.line-cost').name = `StockDetails[${idx}].LineCost`;
            });
            rowIndex = rows.length;
        }

        function calculateTotals() {
            const lineTotals = document.querySelectorAll('.line-total');
            let subTotal = 0;
            lineTotals.forEach(input => {
                subTotal += parseFloat(input.value) || 0;
            });

            let discountAmount;
            if (lastDiscountEdit === 'amount') {
                // User typed a specific discount amount — preserve it, recalculate percent
                discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
                discountAmount = Math.max(0, Math.min(discountAmount, subTotal));
                if (subTotal > 0) {
                    const discountPercent = Math.round(discountAmount / subTotal * 100 * 100) / 100;
                    document.getElementById('discountPercent').value = discountPercent.toFixed(2);
                }
            } else {
                // User typed a percent — calculate amount from percent
                const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
                discountAmount = Math.max(0, Math.round(subTotal * discountPercent / 100 * 100) / 100);
            }
            const totalAmount = Math.max(0, subTotal - discountAmount);

            document.getElementById('subTotalDisplay').textContent = subTotal.toFixed(2);
            document.getElementById('subTotal').value = subTotal.toFixed(2);
            document.getElementById('discountAmount').value = discountAmount.toFixed(2);
            document.getElementById('totalAmountDisplay').textContent = totalAmount.toFixed(2);
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);

            setPaidAmountToTotal();
            calculatePayment();
        }

        // Bi-directional discount: update % when amount changes
        function calculateDiscountFromAmount() {
            const subTotal = parseFloat(document.getElementById('subTotal').value) || 0;
            let discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;

            if (discountAmount < 0) {
                discountAmount = 0;
            }
            if (discountAmount > subTotal) {
                discountAmount = subTotal;
            }
            
            if (subTotal > 0) {
                const discountPercent = Math.round(discountAmount / subTotal * 100 * 100) / 100;
                document.getElementById('discountPercent').value = discountPercent.toFixed(2);
            } else {
                document.getElementById('discountPercent').value = '0';
            }
            
            const totalAmount = Math.max(0, subTotal - discountAmount);
            document.getElementById('discountAmount').value = discountAmount.toFixed(2);
            document.getElementById('totalAmountDisplay').textContent = totalAmount.toFixed(2);
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);

            setPaidAmountToTotal();
            calculatePayment();
        }

        function calculatePayment() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            let tenderedAmount = Math.max(0, parseFloat(document.getElementById('tenderedAmount').value) || 0);
            document.getElementById('tenderedAmount').value = tenderedAmount.toFixed(2);
            const paidAmount = Math.min(totalAmount, tenderedAmount);
            const balance = Math.max(0, totalAmount - paidAmount);
            const change = Math.max(0, tenderedAmount - totalAmount);

            document.getElementById('paidAmount').value = paidAmount.toFixed(2);
            document.getElementById('balanceAmount').value = balance.toFixed(2);

            if (change > 0) {
                document.getElementById('changeContainer').style.display = 'block';
                document.getElementById('balanceContainer').style.display = 'none';
                document.getElementById('changeDisplay').value = change.toFixed(2);
                document.getElementById('balanceDisplay').value = '0.00';
            } else {
                document.getElementById('changeContainer').style.display = 'none';
                document.getElementById('balanceContainer').style.display = 'block';
                document.getElementById('balanceDisplay').value = balance.toFixed(2);
            }

            const paymentSection = document.getElementById('paymentAccountSection');
            const paymentAccountSelect = document.getElementById('paymentAccountId');
            if (totalAmount > 0) {
                const wasHidden = paymentSection.classList.contains('d-none-soft');
                paymentSection.classList.remove('d-none-soft');
                paymentAccountSelect.required = paidAmount > 0;

                // Reinitialize Select2 after section becomes visible (fixes 0-width issue)
                if (wasHidden && window.PharmaCareSelect2) {
                    window.PharmaCareSelect2.reinit(paymentAccountSelect);
                }

                if (!paymentAccountSelect.value) {
                    const lastAccount = localStorage.getItem('sale_last_payment_account_id');
                    if (lastAccount && Array.from(paymentAccountSelect.options).some(opt => opt.value === lastAccount)) {
                        paymentAccountSelect.value = lastAccount;
                        $(paymentAccountSelect).trigger('change');
                    }
                }
            } else {
                paymentSection.classList.add('d-none-soft');
                paymentAccountSelect.required = false;
                paymentAccountSelect.value = '';
            }

            const alertDiv = document.getElementById('paymentStatusAlert');
            const statusText = document.getElementById('paymentStatusText');

            if (totalAmount === 0) {
                alertDiv.className = 'alert alert-secondary mb-0 mt-2';
                statusText.innerHTML = '<i class="fas fa-info-circle me-1"></i>Add items to calculate total';
            } else if (paidAmount >= totalAmount) {
                alertDiv.className = 'alert alert-success mb-0 mt-2';
                const changeText = change > 0 ? ` (Change: ${change.toFixed(2)})` : '';
                statusText.innerHTML = `<i class="fas fa-check-circle me-1"></i>Fully Paid${changeText}`;
            } else if (paidAmount > 0) {
                alertDiv.className = 'alert alert-warning mb-0 mt-2';
                statusText.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>Partial Payment - Balance: ' + balance.toFixed(2);
            } else {
                alertDiv.className = 'alert alert-info mb-0 mt-2';
                statusText.innerHTML = '<i class="fas fa-money-bill me-1"></i>No Payment - Credit Sale';
            }

            document.getElementById('savedAmountCue').textContent = (parseFloat(document.getElementById('discountAmount').value) || 0).toFixed(2);
            document.getElementById('remainingDueCue').textContent = balance.toFixed(2);
            updateSaveButtonState();
        }

        function setPaidAmountToTotal() {
            if (!isPaidAmountAuto) {
                return;
            }

            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            document.getElementById('tenderedAmount').value = totalAmount.toFixed(2);
        }

        function hasStockErrors() {
            return !!document.querySelector('.quantity-input.is-invalid');
        }

        function updateSaveButtonState() {
            const saveButton = document.getElementById('confirmSaveBtn');
            const stockErrorHint = document.getElementById('stockErrorHint');
            const stockErrors = hasStockErrors();

            saveButton.disabled = stockErrors;
            if (stockErrors) {
                stockErrorHint.classList.remove('d-none-soft');
            } else {
                stockErrorHint.classList.add('d-none-soft');
            }
        }

        function validateBeforeSubmit() {
            if (hasStockErrors()) {
                updateSaveButtonState();
                return false;
            }

            const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
            const paymentAccountId = document.getElementById('paymentAccountId');
            if (paidAmount > 0 && !paymentAccountId.value) {
                document.getElementById('paymentAccountSection').style.display = 'block';
                paymentAccountId.required = true;
                paymentAccountId.setCustomValidity('Please select a payment account.');
                paymentAccountId.reportValidity();
                return false;
            }
            paymentAccountId.setCustomValidity('');

            const form = document.getElementById('saleForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return false;
            }

            const rows = document.querySelectorAll('#lineItemsBody tr');
            if (rows.length === 0) {
                alert('Please add at least one product.');
                addLineItem();
                return false;
            }

            return true;
        }

        function isRiskySale() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const isCreditSale = totalAmount > 0 && paidAmount < totalAmount;
            const hasHighDiscount = discountPercent >= HIGH_DISCOUNT_CONFIRM_THRESHOLD;
            return isCreditSale || hasHighDiscount;
        }

        function handleSaveClick() {
            calculateTotals();
            if (!validateBeforeSubmit()) {
                return;
            }

            if (isRiskySale()) {
                showConfirmationModal();
                return;
            }

            persistLastPaymentAccount();
            submitSaleFormInNewTab();
        }

        function showConfirmationModal() {
            if (!validateBeforeSubmit()) {
                return;
            }

            const customerSelect = document.getElementById('customerSelect');
            const customerName = customerSelect.options[customerSelect.selectedIndex]?.text || '-';
            document.getElementById('confirmCustomer').textContent = customerName;

            const dateInput = document.querySelector('input[name="TransactionDate"]');
            document.getElementById('confirmDate').textContent = dateInput.value || '-';

            const confirmItemsBody = document.getElementById('confirmItemsBody');
            confirmItemsBody.innerHTML = '';
            const confirmRows = document.querySelectorAll('#lineItemsBody tr');
            confirmRows.forEach((row, idx) => {
                const productName = row.querySelector('.product-select').options[row.querySelector('.product-select').selectedIndex]?.text || '-';
                const qty = row.querySelector('.quantity-input').value || '0';
                const price = row.querySelector('.price-input').value || '0';
                const total = row.querySelector('.line-total').value || '0';
                confirmItemsBody.innerHTML += `<tr><td>${idx + 1}</td><td>${productName.split(' (Stock')[0]}</td><td>${qty}</td><td>${price}</td><td>${total}</td></tr>`;
            });

            document.getElementById('confirmSubTotal').textContent = document.getElementById('subTotal').value || '0.00';
            document.getElementById('confirmDiscount').textContent = document.getElementById('discountAmount').value || '0.00';
            document.getElementById('confirmTotal').textContent = document.getElementById('totalAmount').value || '0.00';
            document.getElementById('confirmTendered').textContent = document.getElementById('tenderedAmount').value || '0.00';
            document.getElementById('confirmPaid').textContent = document.getElementById('paidAmount').value || '0.00';
            document.getElementById('confirmBalance').textContent = document.getElementById('balanceAmount').value || '0.00';
            document.getElementById('confirmChange').textContent = document.getElementById('changeDisplay').value || '0.00';

            const modal = new bootstrap.Modal(document.getElementById('confirmSaleModal'));
            modal.show();
        }

        function persistLastPaymentAccount() {
            const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
            const paymentAccount = document.getElementById('paymentAccountId').value;
            if (paidAmount > 0 && paymentAccount) {
                localStorage.setItem('sale_last_payment_account_id', paymentAccount);
            }
        }

        async function submitSaleFormInNewTab() {
            const form = document.getElementById('saleForm');
            const formData = new FormData(form);
            const saveBtn = document.getElementById('confirmSaveBtn');

            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                const result = await response.json();

                if (result.success) {
                    // Open receipt in new tab, redirect current tab to sales index
                    window.open(result.receiptUrl, '_blank');
                    window.location.href = result.salesIndexUrl;
                } else {
                    alert(result.message || 'Failed to save sale. Please try again.');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Sale';
                }
            } catch (error) {
                console.error('Error saving sale:', error);
                alert('An error occurred while saving. Please try again.');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Sale';
            }
        }

        // Update margin display when price/cost changes
        function updateMarginDisplay(row) {
            const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
            const costPrice = parseFloat(row.querySelector('.cost-price-input').value) || 0;
            const marginDisplay = row.querySelector('.margin-display');
            
            if (unitPrice > 0 && costPrice > 0) {
                const margin = ((unitPrice - costPrice) / unitPrice) * 100;
                marginDisplay.textContent = margin.toFixed(1) + '%';
                marginDisplay.className = margin >= 0 ? 'badge bg-success margin-display' : 'badge bg-danger margin-display';
            } else if (unitPrice > 0) {
                // No cost price set, show as neutral
                marginDisplay.textContent = '--%';
                marginDisplay.className = 'badge bg-secondary margin-display';
            } else {
                marginDisplay.textContent = '--%';
                marginDisplay.className = 'badge bg-secondary margin-display';
            }
        }
    </script>
}
