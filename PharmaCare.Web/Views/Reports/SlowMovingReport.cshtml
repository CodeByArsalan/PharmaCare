@using PharmaCare.Domain.Models.Configuration
@model List<PharmaCare.Application.DTOs.Reports.SlowMovingItemDto>
@{
    ViewData["Title"] = "Slow Moving Items Report";
    var threshold = ViewBag.DaysThreshold as int? ?? 30;
}

<div class="container-fluid flex-grow-1 p-0">
    <div class="row align-items-center mb-4">
        <div class="col-md-3">
            <h4 class="fw-bold mb-1"><i class='bx bx-time text-warning'></i> Slow Moving Items</h4>
            <p class="text-muted mb-0">Products with low sales velocity</p>
        </div>
        <div class="col-md-9">
            <div class="d-flex flex-wrap gap-3 align-items-center justify-content-end">
                <form method="get" asp-action="SlowMovingReport" class="d-flex gap-2 align-items-center">
                    <input type="hidden" name="daysThreshold" value="@threshold" />
                    <label class="form-label mb-0">Store:</label>
                    <div style="min-width: 300px;">
                        <select name="storeId" class="form-select form-select-lg" onchange="this.form.submit()">
                            @if (ViewBag.IsAdmin == true)
                            {
                                <option value="">All Stores</option>
                            }
                            @if (ViewBag.Stores != null)
                            {
                                foreach (var store in (IEnumerable<Store>)ViewBag.Stores)
                                {
                                    if (ViewBag.SelectedStoreId == store.StoreID)
                                    {
                                        <option value="@Utility.EncryptURL(store.StoreID.ToString2())" selected>@store.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@Utility.EncryptURL(store.StoreID.ToString2())">@store.Name</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                </form>
                <div class="d-flex gap-1 border-start ps-3 just">
                    <a asp-action="SlowMovingReport" asp-route-daysThreshold="30"
                        asp-route-storeId="@ViewBag.SelectedStoreId"
                        class="btn @(threshold == 30 ? "btn-primary" : "btn-outline-primary") btn-lg"
                        style="min-width: 90px;">30 Days</a>
                    <a asp-action="SlowMovingReport" asp-route-daysThreshold="60"
                        asp-route-storeId="@ViewBag.SelectedStoreId"
                        class="btn @(threshold == 60 ? "btn-primary" : "btn-outline-primary") btn-lg"
                        style="min-width: 90px;">60 Days</a>
                    <a asp-action="SlowMovingReport" asp-route-daysThreshold="90"
                        asp-route-storeId="@ViewBag.SelectedStoreId"
                        class="btn @(threshold == 90 ? "btn-primary" : "btn-outline-primary") btn-lg"
                        style="min-width: 90px;">90 Days</a>
                </div>
            </div>
        </div>
        @* <div class="col-md-3 d-none d-md-block"></div> *@
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-warning bg-opacity-10 border-0">
                <div class="card-body text-center">
                    <h3 class="text-white fw-bold">@Model.Count</h3>
                    <small class="text-muted">Slow Moving Items</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-danger bg-opacity-10 border-0">
                <div class="card-body text-center">
                    <h3 class="text-white fw-bold">Rs. @Model.Sum(x => x.StockValue).ToString("N0")</h3>
                    <small class="text-muted">Capital Tied Up</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info bg-opacity-10 border-0">
                <div class="card-body text-center">
                    <h3 class="text-white fw-bold">@Model.Sum(x => x.CurrentStock)</h3>
                    <small class="text-muted">Total Units in Stock</small>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Stock</th>
                            <th>Sold (30d)</th>
                            <th>Sold (90d)</th>
                            <th>Days of Stock</th>
                            <th>Stock Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td><strong>@item.ProductName</strong></td>
                                <td><span class="badge bg-label-secondary">@item.Category</span></td>
                                <td>@item.CurrentStock</td>
                                <td>@item.QuantitySoldLast30Days</td>
                                <td>@item.QuantitySoldLast90Days</td>
                                <td>
                                    @if (item.DaysOfStock > 365)
                                    {
                                        <span class="badge bg-danger">365+ days</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">@((int)item.DaysOfStock) days</span>
                                    }
                                </td>
                                <td class="text-end">Rs. @item.StockValue.ToString("N0")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
