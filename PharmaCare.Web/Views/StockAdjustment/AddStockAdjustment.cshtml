@model PharmaCare.Domain.Models.Inventory.StockAdjustment
@inject PharmaCare.Infrastructure.Interfaces.IComboBoxRepository _comboBox

@{
    ViewData["Title"] = "New Stock Adjustment";
}

<div class="card mb-4">
    <h4 class="card-header">Create Adjustment</h4>
    <div class="card-body mt-3">
        <form asp-action="AddStockAdjustment" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="Store_ID" class="form-label">Store</label>
                    <select asp-for="Store_ID" class="form-control"
                        asp-items="@_comboBox.GetStoresByLoginUserID((int)ViewBag.LoginUserID, Model?.Store_ID)"></select>
                    <span asp-validation-for="Store_ID" class="text-danger"></span>
                </div>

                <!-- Ideally this should be a dynamic selection -->
                <div class="col-md-6 mb-3 position-relative">
                    <label class="form-label">Search Product Batch</label>
                    <div class="input-group mb-2">
                        <span class="input-group-text"><i class="bx bx-search"></i></span>
                        <input type="text" class="form-control" id="productSearch"
                            placeholder="Type product name, generic or barcode..." autocomplete="off">
                    </div>
                    <div id="searchResults" class="list-group position-absolute w-100 shadow-lg border"
                        style="z-index: 1050; max-height: 400px; overflow-y: auto; display: none; background-color: white;">
                    </div>

                    <input asp-for="ProductBatch_ID" type="hidden" />
                    <div id="selectedBatchDisplay" class="mt-2 d-none">
                        <div class="alert alert-outline-primary d-flex align-items-center p-2 mb-0" role="alert">
                            <i class="bx bx-check-circle me-2 fs-4"></i>
                            <div class="flex-grow-1">
                                <div id="selectedProductName" class="fw-bold text-dark"></div>
                                <div class="small">
                                    Batch: <span id="selectedBatchNumber" class="fw-semibold"></span> |
                                    Exp: <span id="selectedExpiry"></span>
                                </div>
                            </div>
                            <button type="button" class="btn-close ms-auto" style="font-size: 0.6rem;"
                                onclick="clearSelection()"></button>
                        </div>
                    </div>
                    <span asp-validation-for="ProductBatch_ID" class="text-danger"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="QuantityAdjusted" class="form-label">Quantity (+ For Found, - For
                        Loss)</label>
                    <input asp-for="QuantityAdjusted" class="form-control" type="number" />
                    <span asp-validation-for="QuantityAdjusted" class="text-danger"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="Reason" class="form-label">Reason</label>
                    <select asp-for="Reason" class="form-control">
                        <option value="">Select Reason</option>
                        <option value="Damaged">Damaged</option>
                        <option value="Expired">Expired</option>
                        <option value="Lost">Lost / Stolen</option>
                        <option value="Found">Stock Found</option>
                        <option value="Correction">Data Correction</option>
                    </select>
                    <span asp-validation-for="Reason" class="text-danger"></span>
                </div>
            </div>

            <div class="mt-3 d-flex justify-content-end gap-2">
                <a asp-action="StockAdjustmentIndex" class="btn btn-secondary"><i class="bx bx-arrow-back me-1"></i>Back
                    to list</a>
                <button type="submit" class="btn btn-success me-2">Create Adjustment</button>
            </div>
        </form>
    </div>
</div>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            let searchTimeout;

            $('#productSearch').on('input', function () {
                clearTimeout(searchTimeout);
                const query = $(this).val();
                if (query.length < 2) {
                    $('#searchResults').empty();
                    return;
                }
                searchTimeout = setTimeout(() => searchProducts(query), 300);
            });

            function searchProducts(query) {
                const storeId = $('#Store_ID').val();
                $.get('/StockAdjustment/SearchBatches', { query: query, storeId: storeId }, function (data) {
                    const container = $('#searchResults');
                    container.empty();

                    if (!data || data.length === 0) {
                        container.append('<div class="list-group-item text-muted text-center py-3">No products found</div>');
                        container.show();
                        return;
                    }

                    data.forEach(product => {
                        // Product Header
                        const productHeader = $(`
                                                <div class="list-group-item list-group-item-light fw-bold py-2 border-bottom shadow-sm" style="background-color: #f8f9fa;">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span>${highlight(product.brandName, query)}</span>
                                                        <small class="text-muted" style="font-size: 0.7rem;">${product.barcode || ''}</small>
                                                    </div>
                                                    <div class="text-muted fw-normal small" style="font-size: 0.8rem;">${product.genericName || ''}</div>
                                                </div>
                                            `);
                        container.append(productHeader);

                        if (product.availableBatches && product.availableBatches.length > 0) {
                            product.availableBatches.forEach(batch => {
                                const isExpired = new Date(batch.expiryDate) < new Date();
                                const item = $(`
                                                        <a href="#" class="list-group-item list-group-item-action ps-4 py-2 border-start border-4 ${isExpired ? 'border-danger' : 'border-success'}">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <span class="fw-semibold text-primary" style="font-size: 0.9rem;">${batch.batchNumber}</span>
                                                                    <span class="ms-2 badge ${isExpired ? 'bg-label-danger' : 'bg-label-secondary'}" style="font-size: 0.7rem;">
                                                                        Exp: ${new Date(batch.expiryDate).toLocaleDateString()}
                                                                    </span>
                                                                </div>
                                                                <div class="text-end">
                                                                    <span class="badge rounded-pill bg-label-info">Stock: ${batch.availableQuantity}</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    `);

                                item.click(function (e) {
                                    e.preventDefault();
                                    selectBatch(batch.productBatchID, batch.batchNumber, batch.expiryDate, product.brandName);
                                });

                                container.append(item);
                            });
                        } else {
                            container.append('<div class="list-group-item ps-4 py-1 small text-muted font-italic">No batches available</div>');
                        }
                    });
                    container.show();
                });
            }

            function highlight(text, query) {
                if (!query) return text;
                const re = new RegExp(`(${query})`, 'gi');
                return text.replace(re, '<mark class="p-0">$1</mark>');
            }

            function selectBatch(id, number, expiry, productName) {
                $('#ProductBatch_ID').val(id);
                $('#selectedBatchNumber').text(number);
                $('#selectedExpiry').text(new Date(expiry).toLocaleDateString());
                $('#selectedProductName').text(productName);

                $('#selectedBatchDisplay').removeClass('d-none');
                $('#searchResults').hide().empty();
                $('#productSearch').val('');
            }

            window.clearSelection = function () {
                $('#ProductBatch_ID').val('');
                $('#selectedBatchDisplay').addClass('d-none');
                $('#productSearch').val('').focus();
            };

            // Hide results when clicking outside
            $(document).click(function (e) {
                if (!$(e.target).closest('#productSearch, #searchResults').length) {
                    $('#searchResults').hide().empty();
                }
            });
        });
    </script>
}
